
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Differential equations &#8212; pycse - Python Computations in Science and Engineering</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script kind="utterances">

    var commentsRunWhenDOMLoaded = cb => {
    if (document.readyState != 'loading') {
        cb()
    } else if (document.addEventListener) {
        document.addEventListener('DOMContentLoaded', cb)
    } else {
        document.attachEvent('onreadystatechange', function() {
        if (document.readyState == 'complete') cb()
        })
    }
}

var addUtterances = () => {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://utteranc.es/client.js";
    script.async = "async";

    script.setAttribute("repo", "jkitchin/dsmles");
    script.setAttribute("issue-term", "pathname");
    script.setAttribute("theme", "github-light");
    script.setAttribute("label", "💬 comment");
    script.setAttribute("crossorigin", "anonymous");

    sections = document.querySelectorAll("div.section");
    if (sections !== null) {
        section = sections[sections.length-1];
        section.appendChild(script);
    }
}
commentsRunWhenDOMLoaded(addUtterances);
</script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-4H7VFJKEZY"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-4H7VFJKEZY');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-4H7VFJKEZY');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'blog/differential-equations';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Plotting" href="plotting.html" />
    <link rel="prev" title="Optimization" href="optimization.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/pycse.png" class="logo__image only-light" alt="pycse - Python Computations in Science and Engineering - Home"/>
    <script>document.write(`<img src="../_static/pycse.png" class="logo__image only-dark" alt="pycse - Python Computations in Science and Engineering - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome to pycse - Python Computations in Science and Engineering
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">The pycse book</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../book/intro.html">The pycse book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/00-intro.html">Introduction to Python and Jupyter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/01-jupyter.html">More about using Jupyter notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/02-integration-1.html">Integration in Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/03-fode-1.html">First-order differential equations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/04-fode-2.html">Systems of first-order differential equations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/05-nth-odes.html">N<sup>th</sup> order differential equations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/07-nla-1.html">Nonlinear algebra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/08-nla-2.html">Polynomials in Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/09-bvp.html">Boundary value problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/10-min-max.html">Introduction to optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/11-regression.html">Nonlinear regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/12-nonlinear-regression-2.html">Uncertainty quantification in nonlinear regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/13-constrained-optimization.html">Constrained optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/15-intro-linear-algebra.html">Introduction to linear algebra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/16-linear-algebra.html">Applications of linear algebra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/17-linear-algebra-2.html">Interpolation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/18-linear-regression.html">Linear regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/20-autograd-applications.html">Introduction to automatic differentiation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/21-machine-learning.html">Introduction to machine learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/22-ml-2.html">Topics in machine learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/23-gp.html">Gaussian Process Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/conclusions.html">Concluding remarks</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">The pycse blog</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="intro.html">The PYCSE blog</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic-python.html">Basic python usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="math.html">Math</a></li>
<li class="toctree-l1"><a class="reference internal" href="linear-algebra.html">Linear algebra</a></li>
<li class="toctree-l1"><a class="reference internal" href="nonlinear-algebra.html">Nonlinear algebra</a></li>
<li class="toctree-l1"><a class="reference internal" href="statistics.html">Statistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-analysis.html">Data analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="interpolation.html">Interpolation</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimization.html">Optimization</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Differential equations</a></li>
<li class="toctree-l1"><a class="reference internal" href="plotting.html">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="units.html">Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="programming.html">Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="worked-examples.html">Worked examples</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">pycse documentation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../docs/about.html">About pycse</a></li>

<li class="toctree-l1"><a class="reference internal" href="../docs/running-pycse.html">Running pycse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/pycse.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/beginner.html">pycse - Beginner mode</a></li>





<li class="toctree-l1"><a class="reference internal" href="../docs/utils.html">pycse.utils</a></li>



<li class="toctree-l1"><a class="reference internal" href="../docs/execution-statistics.html">Build statistics</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://lab.amdatascience.com/hub/user-redirect/git-pull?repo=https%3A//github.com/jkitchin/pycse&urlpath=lab/tree/pycse/pycse-jb/pycse___python_computations_in_science_and_engineering/blog/differential-equations.ipynb&branch=master" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on JupyterHub"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="JupyterHub logo" src="../_static/images/logo_jupyterhub.svg">
  </span>
<span class="btn__text-container">JupyterHub</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/jkitchin/pycse/blob/master/pycse-jb/pycse___python_computations_in_science_and_engineering/blog/differential-equations.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/jkitchin/pycse" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/jkitchin/pycse/edit/master/pycse-jb/pycse___python_computations_in_science_and_engineering/blog/differential-equations.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/jkitchin/pycse/issues/new?title=Issue%20on%20page%20%2Fblog/differential-equations.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/blog/differential-equations.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Differential equations</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ordinary-differential-equations">Ordinary differential equations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#numerical-solution-to-a-simple-ode">Numerical solution to a simple ode</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-ode-solutions-in-cylindrical-coordinates">Plotting ODE solutions in cylindrical coordinates</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#odes-with-discontinuous-forcing-functions">ODEs with discontinuous forcing functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#simulating-the-events-feature-of-matlab-s-ode-solvers">Simulating the events feature of Matlab’s ode solvers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mimicking-ode-events-in-python">Mimicking ode events in python</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solving-an-ode-for-a-specific-solution-value">Solving an ode for a specific solution value</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-simple-first-order-ode-evaluated-at-specific-points">A simple first order ode evaluated at specific points</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#error-tolerance-in-numerical-solutions-to-odes">Error tolerance in numerical solutions to ODEs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solving-parameterized-odes-over-and-over-conveniently">Solving parameterized ODEs over and over conveniently</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#yet-another-way-to-parameterize-an-ode">Yet another way to parameterize an ODE</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#another-way-to-parameterize-an-ode-nested-function">Another way to parameterize an ODE - nested function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solving-a-second-order-ode">Solving a second order ode</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solving-bessel-s-equation-numerically">Solving Bessel’s Equation numerically</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-portraits-of-a-system-of-odes">Phase portraits of a system of ODEs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-algebra-approaches-to-solving-systems-of-constant-coefficient-odes">Linear algebra approaches to solving systems of constant coefficient ODEs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#delay-differential-equations">Delay Differential Equations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#differential-algebraic-systems-of-equations">Differential algebraic systems of equations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#boundary-value-equations">Boundary value equations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plane-poiseuille-flow-bvp-solve-by-shooting-method">Plane Poiseuille flow - BVP solve by shooting method</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#first-guess">First guess</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#second-guess">Second guess</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#let-fsolve-do-the-work">Let fsolve do the work</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plane-poiseuelle-flow-solved-by-finite-difference">Plane poiseuelle flow solved by finite difference</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#boundary-value-problem-in-heat-conduction">Boundary value problem in heat conduction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-nonlinear-bvp">A nonlinear BVP</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-differential-equations">Partial differential equations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#modeling-a-transient-plug-flow-reactor">Modeling a transient plug flow reactor</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#transient-heat-conduction-partial-differential-equations">Transient heat conduction - partial differential equations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#transient-diffusion-partial-differential-equations">Transient diffusion - partial differential equations</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="differential-equations">
<h1>Differential equations<a class="headerlink" href="#differential-equations" title="Link to this heading">#</a></h1>
<p>The key to successfully solving many differential equations is correctly classifying the equations, putting them into a standard form and then picking the appropriate solver. You must be able to determine if an equation is:</p>
<ul class="simple">
<li><p>An ordinary differential equation <span class="math notranslate nohighlight">\(Y' = f(x, Y)\)</span> with</p>
<ul>
<li><p>initial values (good support in python/numpy/scipy)</p></li>
<li><p>boundary values (not difficult to write code for simple cases)</p></li>
</ul>
</li>
<li><p>Delay differential equation</p></li>
<li><p>Differential algebraic equations</p></li>
<li><p>A partial differential equation</p></li>
</ul>
<p>The following sections will illustrate the methods for solving these kinds of equations.</p>
<section id="ordinary-differential-equations">
<h2>Ordinary differential equations<a class="headerlink" href="#ordinary-differential-equations" title="Link to this heading">#</a></h2>
<section id="numerical-solution-to-a-simple-ode">
<h3>Numerical solution to a simple ode<a class="headerlink" href="#numerical-solution-to-a-simple-ode" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="http://matlab.cheme.cmu.edu/2011/08/03/numerical-solution-to-a-simple-ode/">Matlab post</a></p>
<p>Integrate this ordinary differential equation (ode):</p>
<div class="math notranslate nohighlight">
\[\frac{dy}{dt} = y(t)\]</div>
<p>over the time span of 0 to 2. The initial condition is y(0) = 1.</p>
<p>to solve this equation, you need to create a function of the form: dydt = f(y, t) and then use one of the odesolvers, e.g. odeint.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">odeint</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fprime</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">y</span>

<span class="n">tspan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
<span class="n">y0</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">ysol</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">fprime</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">tspan</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tspan</span><span class="p">,</span> <span class="n">ysol</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;numerical solution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tspan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">tspan</span><span class="p">),</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;analytical solution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y(t)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c4c48e6057d5b2aa3fbc96956418a0a531569b58cf7336caaf17d2d4e0d215d4.png" src="../_images/c4c48e6057d5b2aa3fbc96956418a0a531569b58cf7336caaf17d2d4e0d215d4.png" />
</div>
</div>
<p>The numerical and analytical solutions agree.</p>
<p>Now, suppose you want to know at what time is the solution equal to 3? There are several approaches to this, including setting up a solver, or using an event like approach to stop integration at y=3. A simple approach is to use reverse interpolation. We simply reverse the x and y vectors so that y is the independent variable, and we interpolate the corresponding x-value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">odeint</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fprime</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">y</span>

<span class="n">tspan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">y0</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">ysol</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">fprime</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">tspan</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span>

<span class="n">ip</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">ysol</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">tspan</span><span class="p">)</span> <span class="c1"># reverse interpolation</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;y = 3 at x = </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ip</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>y = 3 at x = 1.098547805640928
</pre></div>
</div>
</div>
</div>
</section>
<section id="plotting-ode-solutions-in-cylindrical-coordinates">
<h3>Plotting ODE solutions in cylindrical coordinates<a class="headerlink" href="#plotting-ode-solutions-in-cylindrical-coordinates" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="http://matlab.cheme.cmu.edu/2011/11/08/plot-the-solution-to-an-ode-in-cylindrical-coordinates-2/">Matlab post</a></p>
<p>It is straightforward to plot functions in Cartesian coordinates. It is less convenient to plot them in cylindrical coordinates. Here we solve an ODE in cylindrical coordinates, and then convert the solution to Cartesian coordinates for simple plotting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">odeint</span>

<span class="k">def</span><span class="w"> </span><span class="nf">dfdt</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">rho</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">F</span>
    <span class="n">drhodt</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># constant radius</span>
    <span class="n">dthetadt</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># constant angular velocity</span>
    <span class="n">dzdt</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>    <span class="c1"># constant dropping velocity</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">drhodt</span><span class="p">,</span> <span class="n">dthetadt</span><span class="p">,</span> <span class="n">dzdt</span><span class="p">]</span>

<span class="c1"># initial conditions</span>
<span class="n">rho0</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">theta0</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">z0</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">tspan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">dfdt</span><span class="p">,</span> <span class="p">[</span><span class="n">rho0</span><span class="p">,</span> <span class="n">theta0</span><span class="p">,</span> <span class="n">z0</span><span class="p">],</span> <span class="n">tspan</span><span class="p">)</span>

<span class="n">rho</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>

<span class="c1"># convert cylindrical coords to cartesian for plotting.</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1a15374e93328ebc537329d97f965c1f168d9ca5fe6f6da91cc43b5631045d3d.png" src="../_images/1a15374e93328ebc537329d97f965c1f168d9ca5fe6f6da91cc43b5631045d3d.png" />
</div>
</div>
</section>
<section id="odes-with-discontinuous-forcing-functions">
<h3>ODEs with discontinuous forcing functions<a class="headerlink" href="#odes-with-discontinuous-forcing-functions" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="http://matlab.cheme.cmu.edu/2011/09/01/odes-with-discontinuous-forcing-functions/">Matlab post</a></p>
<p>Adapted from <a class="reference external" href="http://archives.math.utk.edu/ICTCM/VOL18/S046/paper.pdf">http://archives.math.utk.edu/ICTCM/VOL18/S046/paper.pdf</a></p>
<p>A mixing tank initially contains 300 g of salt mixed into 1000 L of water. At t=0 min, a solution of 4 g/L salt enters the tank at 6 L/min. At t=10 min, the solution is changed to 2 g/L salt, still entering at 6 L/min. The tank is well stirred, and the tank solution leaves at a rate of 6 L/min. Plot the concentration of salt (g/L) in the tank as a function of time.</p>
<p>A mass balance on the salt in the tank leads to this differential equation: <span class="math notranslate nohighlight">\(\frac{dM_S}{dt} = \nu C_{S,in}(t) - \nu M_S/V\)</span> with the initial condition that <span class="math notranslate nohighlight">\(M_S(t=0)=300\)</span>. The wrinkle is that the inlet conditions are not constant.</p>
<div class="math notranslate nohighlight">
\[\begin{split}C_{S,in}(t) = \begin{array}{ll} 0 &amp; t \le 0, \\ 4 &amp; 0 &lt; t \le 10, \\ 2 &amp; t &gt; 10. \end{array}\end{split}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">odeint</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">V</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="c1"># L</span>
<span class="n">nu</span> <span class="o">=</span> <span class="mf">6.0</span>  <span class="c1"># L/min</span>

<span class="k">def</span><span class="w"> </span><span class="nf">Cs_in</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="s1">&#39;inlet concentration&#39;</span>
    <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Cs</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># g/L</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="n">Cs</span> <span class="o">=</span> <span class="mf">4.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Cs</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="k">return</span> <span class="n">Cs</span>

<span class="k">def</span><span class="w"> </span><span class="nf">mass_balance</span><span class="p">(</span><span class="n">Ms</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="s1">&#39;$</span><span class="se">\f</span><span class="s1">rac</span><span class="si">{dM_S}{dt}</span><span class="s1"> = </span><span class="se">\n</span><span class="s1">u C_{S,in}(t) - </span><span class="se">\n</span><span class="s1">u M_S/V$&#39;</span>
    <span class="n">dMsdt</span> <span class="o">=</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">Cs_in</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">-</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">Ms</span> <span class="o">/</span> <span class="n">V</span>
    <span class="k">return</span> <span class="n">dMsdt</span>

<span class="n">tspan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">M0</span> <span class="o">=</span> <span class="mf">300.0</span> <span class="c1"># gm salt</span>
<span class="n">Ms</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">mass_balance</span><span class="p">,</span> <span class="n">M0</span><span class="p">,</span> <span class="n">tspan</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tspan</span><span class="p">,</span> <span class="n">Ms</span><span class="o">/</span><span class="n">V</span><span class="p">,</span> <span class="s1">&#39;b.-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (min)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Salt concentration (g/L)&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8b30374941d69634b2ce1ab399fd35b5d798d307d610611786f6faa1eeb9d231.png" src="../_images/8b30374941d69634b2ce1ab399fd35b5d798d307d610611786f6faa1eeb9d231.png" />
</div>
</div>
<p>You can see the discontinuity in the salt concentration at 10 minutes due to the discontinous change in the entering salt concentration.</p>
</section>
<section id="simulating-the-events-feature-of-matlab-s-ode-solvers">
<h3>Simulating the events feature of Matlab’s ode solvers<a class="headerlink" href="#simulating-the-events-feature-of-matlab-s-ode-solvers" title="Link to this heading">#</a></h3>
<p>The ode solvers in Matlab allow you create functions that define events that can stop the integration, detect roots, etc… We will explore how to get a similar effect in python. Here is an example that somewhat does this, but it is only an approximation. We will manually integrate the ODE, adjusting the time step in each iteration to zero in on the solution. When the desired accuracy is reached, we stop the integration.</p>
<p><span class="timestamp-wrapper"><span class="timestamp">[2023-06-08 Thu] </span></span> events are now supported in scipy.integrate.solve_ivp.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">odeint</span>

<span class="k">def</span><span class="w"> </span><span class="nf">dCadt</span><span class="p">(</span><span class="n">Ca</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="s2">&quot;the ode function&quot;</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mf">0.23</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">k</span> <span class="o">*</span> <span class="n">Ca</span><span class="o">**</span><span class="mi">2</span>

<span class="n">Ca0</span> <span class="o">=</span> <span class="mf">2.3</span>

<span class="c1"># create lists to store time span and solution</span>
<span class="n">tspan</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">]</span>
<span class="n">sol</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ca0</span><span class="p">,]</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>   <span class="c1"># take max of 100 steps</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">tspan</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">Ca</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c1"># pick the next time using a Newton-Raphson method</span>
    <span class="c1"># we want f(t, Ca) = (Ca(t) - 1)**2 = 0</span>
    <span class="c1"># df/dt = df/dCa dCa/dt</span>
    <span class="c1">#       = 2*(Ca - 1) * dCadt</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">-</span> <span class="p">(</span><span class="n">Ca</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">Ca</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span><span class="n">dCadt</span><span class="p">(</span><span class="n">Ca</span><span class="p">,</span> <span class="n">t1</span><span class="p">))</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">dCadt</span><span class="p">,</span> <span class="n">Ca</span><span class="p">,</span> <span class="p">[</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Ca</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1e-4</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Solution reached at i = </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">break</span>

    <span class="n">tspan</span> <span class="o">+=</span> <span class="p">[</span><span class="n">t2</span><span class="p">]</span>
    <span class="n">sol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;At t=</span><span class="si">{0:1.2f}</span><span class="s1">  Ca = </span><span class="si">{1:1.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tspan</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tspan</span><span class="p">,</span> <span class="n">sol</span><span class="p">,</span> <span class="s1">&#39;bo&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Solution reached at i = 15
At t=2.46  Ca = 1.000
</pre></div>
</div>
<img alt="../_images/21a74c24959ab1611330922d7cefa010cf5a47f83498225d7e4249042e77bd26.png" src="../_images/21a74c24959ab1611330922d7cefa010cf5a47f83498225d7e4249042e77bd26.png" />
</div>
</div>
<p>This particular solution works for this example, probably because it is well behaved. It is “downhill” to the desired solution. It is not obvious this would work for every example, and it is certainly possible the algorithm could go “backward” in time. A better approach might be to integrate forward until you detect a sign change in your event function, and then refine it in a separate loop.</p>
<p>I like the events integration in Matlab better, but this is actually pretty functional. It should not be too hard to use this for root counting, e.g. by counting sign changes. It would be considerably harder to get the actual roots. It might also be hard to get the positions of events that include the sign or value of the derivatives at the event points.</p>
<p>ODE solving in Matlab is considerably more advanced in functionality than in scipy. There do seem to be some extra packages, e.g. pydstools, scikits.odes that add extra ode functionality.</p>
</section>
<section id="mimicking-ode-events-in-python">
<h3>Mimicking ode events in python<a class="headerlink" href="#mimicking-ode-events-in-python" title="Link to this heading">#</a></h3>
<p>The ODE functions in scipy.integrate do not directly support events like the functions in Matlab do. We can achieve something like it though, by digging into the guts of the solver, and writing a little code. In  previous <a class="reference external" href="http://matlab.cheme.cmu.edu/2011/09/10/counting-roots/">example</a> I used an event to count the number of roots in a function by integrating the derivative of the function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">odeint</span>

<span class="k">def</span><span class="w"> </span><span class="nf">myode</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">3</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">12</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span><span class="mi">4</span>

<span class="k">def</span><span class="w"> </span><span class="nf">event</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="s1">&#39;an event is when f = 0&#39;</span>
    <span class="k">return</span> <span class="n">f</span>

<span class="c1"># initial conditions</span>
<span class="n">x0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">8</span>
<span class="n">f0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">120</span>

<span class="c1"># final x-range and step to integrate over.</span>
<span class="n">xf</span> <span class="o">=</span> <span class="mi">4</span>   <span class="c1">#final x value</span>
<span class="n">deltax</span> <span class="o">=</span> <span class="mf">0.45</span> <span class="c1">#xstep</span>

<span class="c1"># lists to store the results in</span>
<span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">]</span>
<span class="n">sol</span> <span class="o">=</span> <span class="p">[</span><span class="n">f0</span><span class="p">]</span>
<span class="n">e</span> <span class="o">=</span> <span class="p">[</span><span class="n">event</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="n">x0</span><span class="p">)]</span>
<span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">x0</span>
<span class="c1"># manually integrate at each time step, and check for event sign changes at each step</span>
<span class="k">while</span> <span class="n">x2</span> <span class="o">&lt;=</span> <span class="n">xf</span><span class="p">:</span> <span class="c1">#stop integrating when we get to xf</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">deltax</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">f2</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">myode</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">])</span> <span class="c1"># integrate from x1,f1 to x2,f2</span>
    <span class="n">X</span> <span class="o">+=</span> <span class="p">[</span><span class="n">x2</span><span class="p">]</span>
    <span class="n">sol</span> <span class="o">+=</span> <span class="p">[</span><span class="n">f2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

    <span class="c1"># now evaluate the event at the last position</span>
    <span class="n">e</span> <span class="o">+=</span> <span class="p">[</span><span class="n">event</span><span class="p">(</span><span class="n">sol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>

    <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">e</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Event detected where the sign of the event has changed. The</span>
        <span class="c1"># event is between xPt = X[-2] and xLt = X[-1]. run a modified bisect</span>
        <span class="c1"># function to narrow down to find where event = 0</span>
        <span class="n">xLt</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fLt</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">eLt</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">xPt</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">fPt</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">ePt</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xLt</span> <span class="o">-</span> <span class="n">xPt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                <span class="c1"># we know the interval to a prescribed precision now.</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;x = </span><span class="si">{0}</span><span class="s1">, event = </span><span class="si">{1}</span><span class="s1">, f = </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xLt</span><span class="p">,</span> <span class="n">eLt</span><span class="p">,</span> <span class="n">fLt</span><span class="p">))</span>
                <span class="n">events</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">xLt</span><span class="p">,</span> <span class="n">fLt</span><span class="p">)]</span>
                <span class="k">break</span> <span class="c1"># and return to integrating</span>

            <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">ePt</span> <span class="o">-</span> <span class="n">eLt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">xPt</span> <span class="o">-</span> <span class="n">xLt</span><span class="p">)</span> <span class="c1">#slope of line connecting points</span>
                                        <span class="c1">#bracketing zero</span>

            <span class="c1">#estimated x where the zero is</span>
            <span class="n">new_x</span> <span class="o">=</span> <span class="o">-</span><span class="n">ePt</span> <span class="o">/</span> <span class="n">m</span> <span class="o">+</span> <span class="n">xPt</span>

            <span class="c1"># now get the new value of the integrated solution at that new x</span>
            <span class="n">f</span>  <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">myode</span><span class="p">,</span> <span class="n">fPt</span><span class="p">,</span> <span class="p">[</span><span class="n">xPt</span><span class="p">,</span> <span class="n">new_x</span><span class="p">])</span>
            <span class="n">new_f</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">new_e</span> <span class="o">=</span> <span class="n">event</span><span class="p">(</span><span class="n">new_f</span><span class="p">,</span> <span class="n">new_x</span><span class="p">)</span>

            <span class="c1"># now check event sign change</span>
            <span class="k">if</span> <span class="n">eLt</span> <span class="o">*</span> <span class="n">new_e</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">xPt</span> <span class="o">=</span> <span class="n">new_x</span>
                <span class="n">fPt</span> <span class="o">=</span> <span class="n">new_f</span>
                <span class="n">ePt</span> <span class="o">=</span> <span class="n">new_e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xLt</span> <span class="o">=</span> <span class="n">new_x</span>
                <span class="n">fLt</span> <span class="o">=</span> <span class="n">new_f</span>
                <span class="n">eLt</span> <span class="o">=</span> <span class="n">new_e</span>

            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">sol</span><span class="p">)</span>

<span class="c1"># add event points to the graph</span>
<span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="s1">&#39;bo &#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>x = -6.000000064427786, event = -4.6351811278100286e-15, f = -4.6351811278100286e-15
x = -1.9999999623352622, event = -1.4051260155411128e-15, f = -1.4051260155411128e-15
x = 1.999999886950595, event = -1.1102230246251565e-15, f = -1.1102230246251565e-15
</pre></div>
</div>
<img alt="../_images/f829d3d4825c29857564759b10b4ce54bbd1c83c0fa5936c2f1b2f84bca809ab.png" src="../_images/f829d3d4825c29857564759b10b4ce54bbd1c83c0fa5936c2f1b2f84bca809ab.png" />
</div>
</div>
<p>That was a lot of programming to do something like find the roots of the function! Today I would use solve_ivp for this.</p>
</section>
<section id="solving-an-ode-for-a-specific-solution-value">
<h3>Solving an ode for a specific solution value<a class="headerlink" href="#solving-an-ode-for-a-specific-solution-value" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="http://matlab.cheme.cmu.edu/2011/08/31/solving-an-ode-for-a-specific-solution-value/">Matlab post</a>
The analytical solution to an ODE is a function, which can be solved to get a particular value, e.g. if the solution to an ODE is y(x) = exp(x), you can solve the solution to find the value of x that makes <span class="math notranslate nohighlight">\(y(x)=2\)</span>. In a numerical solution to an ODE we get a vector of independent variable values, and the corresponding function values at those values. To solve for a particular function value we need a different approach. This post will show one way to do that in python.</p>
<p>Given that the concentration of a species A in a constant volume, batch reactor obeys this differential equation <span class="math notranslate nohighlight">\(\frac{dC_A}{dt}=- k C_A^2\)</span> with the initial condition <span class="math notranslate nohighlight">\(C_A(t=0) = 2.3\)</span> mol/L and <span class="math notranslate nohighlight">\(k = 0.23\)</span> L/mol/s, compute the time it takes for <span class="math notranslate nohighlight">\(C_A\)</span> to be reduced to 1 mol/L.</p>
<p>We will get a solution, then create an interpolating function and use fsolve to get the answer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">odeint</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">fsolve</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">k</span> <span class="o">=</span> <span class="mf">0.23</span>
<span class="n">Ca0</span> <span class="o">=</span> <span class="mf">2.3</span>

<span class="k">def</span><span class="w"> </span><span class="nf">dCadt</span><span class="p">(</span><span class="n">Ca</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">k</span> <span class="o">*</span> <span class="n">Ca</span><span class="o">**</span><span class="mi">2</span>

<span class="n">tspan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="n">sol</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">dCadt</span><span class="p">,</span> <span class="n">Ca0</span><span class="p">,</span> <span class="n">tspan</span><span class="p">)</span>
<span class="n">Ca</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tspan</span><span class="p">,</span> <span class="n">Ca</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$C_A$ (mol/L)&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/94071e045277b99580ae452662de209c3c0781a13e1474bd97e32a7f42c609d7.png" src="../_images/94071e045277b99580ae452662de209c3c0781a13e1474bd97e32a7f42c609d7.png" />
</div>
</div>
<p>You can see the solution is near two seconds. Now we create an interpolating function to evaluate the solution. We will plot the interpolating function on a finer grid to make sure it seems reasonable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ca_func</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">tspan</span><span class="p">,</span> <span class="n">Ca</span><span class="p">,</span> <span class="s1">&#39;cubic&#39;</span><span class="p">)</span>

<span class="n">itime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tspan</span><span class="p">,</span> <span class="n">Ca</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">itime</span><span class="p">,</span> <span class="n">ca_func</span><span class="p">(</span><span class="n">itime</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$C_A$ (mol/L)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;solution&#39;</span><span class="p">,</span><span class="s1">&#39;interpolated&#39;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1924a4f6c4363453443d0027266d84b1a6ecc276e9e1f93f2aa8f890ae0145e9.png" src="../_images/1924a4f6c4363453443d0027266d84b1a6ecc276e9e1f93f2aa8f890ae0145e9.png" />
</div>
</div>
<p>that looks pretty reasonable. Now we solve the problem.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tguess</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">tsol</span><span class="p">,</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">ca_func</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">tguess</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tsol</span><span class="p">)</span>

<span class="c1"># you might prefer an explicit function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">ca_func</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<span class="n">tsol2</span><span class="p">,</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">tguess</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tsol2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.4574668234994665
2.4574668234994665
</pre></div>
</div>
</div>
</div>
<p>That is it. Interpolation can provide a simple way to evaluate the numerical solution of an ODE at other values.</p>
<p>For completeness we examine a final way to construct the function. We can actually integrate the ODE in the function to evaluate the solution at the point of interest. If it is not computationally expensive to evaluate the ODE solution this works fine. Note, however, that the ODE will get integrated from 0 to the value t for each iteration of fsolve.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="n">tspan</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>
    <span class="n">sol</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">dCadt</span><span class="p">,</span> <span class="n">Ca0</span><span class="p">,</span> <span class="n">tspan</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">tsol3</span><span class="p">,</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">tguess</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tsol3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">line</span> <span class="mi">6</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="n">sol</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">dCadt</span><span class="p">,</span> <span class="n">Ca0</span><span class="p">,</span> <span class="n">tspan</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="ne">----&gt; </span><span class="mi">6</span> <span class="n">tsol3</span><span class="p">,</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">tguess</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="nb">print</span><span class="p">(</span><span class="n">tsol3</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/scipy/optimize/_minpack_py.py:171,</span> in <span class="ni">fsolve</span><span class="nt">(func, x0, args, fprime, full_output, col_deriv, xtol, maxfev, band, epsfcn, factor, diag)</span>
<span class="g g-Whitespace">    </span><span class="mi">161</span> <span class="n">_wrapped_func</span><span class="o">.</span><span class="n">nfev</span> <span class="o">=</span> <span class="mi">0</span>
<span class="g g-Whitespace">    </span><span class="mi">163</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;col_deriv&#39;</span><span class="p">:</span> <span class="n">col_deriv</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">164</span>            <span class="s1">&#39;xtol&#39;</span><span class="p">:</span> <span class="n">xtol</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">165</span>            <span class="s1">&#39;maxfev&#39;</span><span class="p">:</span> <span class="n">maxfev</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>    <span class="mi">168</span>            <span class="s1">&#39;factor&#39;</span><span class="p">:</span> <span class="n">factor</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">169</span>            <span class="s1">&#39;diag&#39;</span><span class="p">:</span> <span class="n">diag</span><span class="p">}</span>
<span class="ne">--&gt; </span><span class="mi">171</span> <span class="n">res</span> <span class="o">=</span> <span class="n">_root_hybr</span><span class="p">(</span><span class="n">_wrapped_func</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">fprime</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">172</span> <span class="n">res</span><span class="o">.</span><span class="n">nfev</span> <span class="o">=</span> <span class="n">_wrapped_func</span><span class="o">.</span><span class="n">nfev</span>
<span class="g g-Whitespace">    </span><span class="mi">174</span> <span class="k">if</span> <span class="n">full_output</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/scipy/optimize/_minpack_py.py:239,</span> in <span class="ni">_root_hybr</span><span class="nt">(func, x0, args, jac, col_deriv, xtol, maxfev, band, eps, factor, diag, **unknown_options)</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">238</span>     <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="p">,)</span>
<span class="ne">--&gt; </span><span class="mi">239</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">_check_func</span><span class="p">(</span><span class="s1">&#39;fsolve&#39;</span><span class="p">,</span> <span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,))</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span> <span class="k">if</span> <span class="n">epsfcn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>     <span class="n">epsfcn</span> <span class="o">=</span> <span class="n">finfo</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/scipy/optimize/_minpack_py.py:24,</span> in <span class="ni">_check_func</span><span class="nt">(checker, argname, thefunc, x0, args, numinputs, output_shape)</span>
<span class="g g-Whitespace">     </span><span class="mi">22</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_func</span><span class="p">(</span><span class="n">checker</span><span class="p">,</span> <span class="n">argname</span><span class="p">,</span> <span class="n">thefunc</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">numinputs</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">23</span>                 <span class="n">output_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">24</span>     <span class="n">res</span> <span class="o">=</span> <span class="n">atleast_1d</span><span class="p">(</span><span class="n">thefunc</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">x0</span><span class="p">[:</span><span class="n">numinputs</span><span class="p">],)</span> <span class="o">+</span> <span class="n">args</span><span class="p">)))</span>
<span class="g g-Whitespace">     </span><span class="mi">25</span>     <span class="k">if</span> <span class="p">(</span><span class="n">output_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">!=</span> <span class="n">output_shape</span><span class="p">):</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span>         <span class="k">if</span> <span class="p">(</span><span class="n">output_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/scipy/optimize/_minpack_py.py:159,</span> in <span class="ni">fsolve.&lt;locals&gt;._wrapped_func</span><span class="nt">(*fargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">154</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">155</span><span class="sd"> Wrapped `func` to track the number of times</span>
<span class="g g-Whitespace">    </span><span class="mi">156</span><span class="sd"> the function has been called.</span>
<span class="g g-Whitespace">    </span><span class="mi">157</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">158</span> <span class="n">_wrapped_func</span><span class="o">.</span><span class="n">nfev</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="ne">--&gt; </span><span class="mi">159</span> <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">fargs</span><span class="p">)</span>

<span class="nn">Cell In[10], line 3,</span> in <span class="ni">func</span><span class="nt">(t)</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="n">tspan</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>
<span class="ne">----&gt; </span><span class="mi">3</span>     <span class="n">sol</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">dCadt</span><span class="p">,</span> <span class="n">Ca0</span><span class="p">,</span> <span class="n">tspan</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/scipy/integrate/_odepack_py.py:244,</span> in <span class="ni">odeint</span><span class="nt">(func, y0, t, args, Dfun, col_deriv, full_output, ml, mu, rtol, atol, tcrit, h0, hmax, hmin, ixpr, mxstep, mxhnil, mxordn, mxords, printmessg, tfirst)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span> <span class="k">if</span> <span class="n">mu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="n">mu</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># changed to zero inside function call</span>
<span class="ne">--&gt; </span><span class="mi">244</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">dt</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()):</span>
<span class="g g-Whitespace">    </span><span class="mi">246</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The values in t must be monotonically increasing &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">247</span>                      <span class="s2">&quot;or monotonically decreasing; repeated values are &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>                      <span class="s2">&quot;allowed.&quot;</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/numpy/lib/_function_base_impl.py:1481,</span> in <span class="ni">diff</span><span class="nt">(a, n, axis, prepend, append)</span>
<span class="g g-Whitespace">   </span><span class="mi">1477</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1478</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1479</span>         <span class="s2">&quot;order must be non-negative but got &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
<span class="ne">-&gt; </span><span class="mi">1481</span> <span class="n">a</span> <span class="o">=</span> <span class="n">asanyarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1482</span> <span class="n">nd</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span>
<span class="g g-Whitespace">   </span><span class="mi">1483</span> <span class="k">if</span> <span class="n">nd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

<span class="ne">ValueError</span>: setting an array element with a sequence. The requested array has an inhomogeneous shape after 1 dimensions. The detected shape was (2,) + inhomogeneous part.
</pre></div>
</div>
</div>
</div>
</section>
<section id="a-simple-first-order-ode-evaluated-at-specific-points">
<h3>A simple first order ode evaluated at specific points<a class="headerlink" href="#a-simple-first-order-ode-evaluated-at-specific-points" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="http://matlab.cheme.cmu.edu/2011/08/05/a-simple-first-order-ode-evaluated-at-specific-points/">Matlab post</a></p>
<p>We have integrated an ODE over a specific time span. Sometimes it is desirable to get the solution at specific points, e.g. at t = [0 0.2 0.4 0.8]; This could be desirable to compare with experimental measurements at those time points. This example demonstrates how to do that.</p>
<div class="math notranslate nohighlight">
\[\frac{dy}{dt} = y(t)\]</div>
<p>The initial condition is y(0) = 1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">odeint</span>

<span class="n">y0</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">tspan</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">dydt</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">y</span>

<span class="n">Y</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">dydt</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">tspan</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Y</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1.         1.22140275 1.49182469 2.22554103]
</pre></div>
</div>
</div>
</div>
</section>
<section id="error-tolerance-in-numerical-solutions-to-odes">
<h3>Error tolerance in numerical solutions to ODEs<a class="headerlink" href="#error-tolerance-in-numerical-solutions-to-odes" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="http://matlab.cheme.cmu.edu/2011/09/18/error-tolerance-in-numerical-solutions-to-odes/">Matlab post</a></p>
<p>Usually, the numerical ODE solvers in python work well with the standard settings. Sometimes they do not, and it is not always obvious they have not worked! Part of using a tool like python is checking how well your solution really worked. We use an example of integrating an ODE that defines the van der Waal equation of an ideal gas here.</p>
<p>we plot the analytical solution to the van der waal equation in reduced form here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">Tr</span> <span class="o">=</span> <span class="mf">0.9</span>
<span class="n">Vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.34</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>

<span class="c1">#analytical equation for Pr</span>
<span class="n">Prfh</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">Vr</span><span class="p">:</span> <span class="mf">8.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">Tr</span> <span class="o">/</span> <span class="p">(</span><span class="n">Vr</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">Vr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">Pr</span> <span class="o">=</span> <span class="n">Prfh</span><span class="p">(</span><span class="n">Vr</span><span class="p">)</span> <span class="c1"># evaluated on our reduced volume vector.</span>

<span class="c1"># Plot the EOS</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Vr</span><span class="p">,</span><span class="n">Pr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;$V_R$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$P_R$&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f6d3c2b85f210fac9b4a8f8a5fe4b5a814155148af6806b5ed93f5f4535fd34d.png" src="../_images/f6d3c2b85f210fac9b4a8f8a5fe4b5a814155148af6806b5ed93f5f4535fd34d.png" />
</div>
</div>
<p>we want an equation for dPdV, which we will integrate we use symbolic math to do the derivative for us.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="kn">import</span> <span class="n">diff</span><span class="p">,</span> <span class="n">Symbol</span>
<span class="n">Vrs</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;Vrs&#39;</span><span class="p">)</span>

<span class="n">Prs</span> <span class="o">=</span> <span class="mf">8.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">Tr</span> <span class="o">/</span> <span class="p">(</span><span class="n">Vrs</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.0</span><span class="o">/</span><span class="p">(</span><span class="n">Vrs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">diff</span><span class="p">(</span><span class="n">Prs</span><span class="p">,</span><span class="n">Vrs</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-2.4/(Vrs - 0.333333333333333)**2 + 6.0/Vrs**3
</pre></div>
</div>
</div>
</div>
<p>Now, we solve the ODE. We will specify a large relative tolerance criteria (Note the default is much smaller than what we show here).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">odeint</span>

<span class="k">def</span><span class="w"> </span><span class="nf">myode</span><span class="p">(</span><span class="n">Pr</span><span class="p">,</span> <span class="n">Vr</span><span class="p">):</span>
    <span class="n">dPrdVr</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.4</span><span class="o">/</span><span class="p">(</span><span class="n">Vr</span> <span class="o">-</span> <span class="mf">0.333333333333333</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">6.0</span><span class="o">/</span><span class="n">Vr</span><span class="o">**</span><span class="mi">3</span>
    <span class="k">return</span> <span class="n">dPrdVr</span>

<span class="n">Vspan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.334</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">Po</span> <span class="o">=</span> <span class="n">Prfh</span><span class="p">(</span><span class="n">Vspan</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">P</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">myode</span><span class="p">,</span> <span class="n">Po</span><span class="p">,</span> <span class="n">Vspan</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>

<span class="c1"># Plot the EOS</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Vr</span><span class="p">,</span><span class="n">Pr</span><span class="p">)</span> <span class="c1"># analytical solution</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Vspan</span><span class="p">,</span> <span class="n">P</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;r.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;$V_R$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$P_R$&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/98083f18391b6fbc23b320ae22608e533362791b4f098853b9c5f802829a98ce.png" src="../_images/98083f18391b6fbc23b320ae22608e533362791b4f098853b9c5f802829a98ce.png" />
</div>
</div>
<p>You can see there is disagreement between the analytical solution and numerical solution. The origin of this problem is accuracy at the initial condition, where the derivative is extremely large.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">myode</span><span class="p">(</span><span class="n">Po</span><span class="p">,</span> <span class="mf">0.34</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-53847.34378179728
</pre></div>
</div>
</div>
</div>
<p>We can increase the tolerance criteria to get a better answer. The defaults in odeint are actually set to 1.49012e-8.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vspan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.334</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">Po</span> <span class="o">=</span> <span class="n">Prfh</span><span class="p">(</span><span class="n">Vspan</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">P</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">myode</span><span class="p">,</span> <span class="n">Po</span><span class="p">,</span> <span class="n">Vspan</span><span class="p">)</span>

<span class="c1"># Plot the EOS</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Vr</span><span class="p">,</span><span class="n">Pr</span><span class="p">)</span> <span class="c1"># analytical solution</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Vspan</span><span class="p">,</span> <span class="n">P</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;r.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;$V_R$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$P_R$&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8fe8caa33299483f19960b620b160518d3619a2cae3192c89c56c430e30796f4.png" src="../_images/8fe8caa33299483f19960b620b160518d3619a2cae3192c89c56c430e30796f4.png" />
</div>
</div>
<p>The problem here was the derivative value varied by four orders of magnitude over the integration range, so the default tolerances were insufficient to accurately estimate the numerical derivatives over that range. Tightening the tolerances helped resolve that problem. Another approach might be to split the integration up into different regions. For instance, if instead of starting at Vr = 0.34, which is very close to a sigularity in the van der waal equation at Vr = 1/3, if you start at Vr = 0.5, the solution integrates just fine with the standard tolerances.</p>
</section>
<section id="solving-parameterized-odes-over-and-over-conveniently">
<h3>Solving parameterized ODEs over and over conveniently<a class="headerlink" href="#solving-parameterized-odes-over-and-over-conveniently" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="http://matlab.cheme.cmu.edu/2011/09/16/parameterized-odes/">Matlab post</a></p>
<p>Sometimes we have an ODE that depends on a parameter, and we want to solve the ODE for several parameter values. It is inconvenient to write an ode function for each parameter case. Here we examine a convenient way to solve this problem; we pass the parameter to the ODE at runtime. We consider the following ODE:</p>
<div class="math notranslate nohighlight">
\[\frac{dCa}{dt} = -k Ca(t)\]</div>
<p>where <span class="math notranslate nohighlight">\(k\)</span> is a parameter, and we want to solve the equation for a couple of values of <span class="math notranslate nohighlight">\(k\)</span> to test the sensitivity of the solution on the parameter. Our question is, given <span class="math notranslate nohighlight">\(Ca(t=0)=2\)</span>, how long does it take to get <span class="math notranslate nohighlight">\(Ca = 1\)</span>, and how sensitive is the answer to small variations in <span class="math notranslate nohighlight">\(k\)</span>?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">odeint</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">myode</span><span class="p">(</span><span class="n">Ca</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="s1">&#39;ODE definition&#39;</span>
    <span class="n">dCadt</span> <span class="o">=</span> <span class="o">-</span><span class="n">k</span> <span class="o">*</span> <span class="n">Ca</span>
    <span class="k">return</span> <span class="n">dCadt</span>

<span class="n">tspan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">k0</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">Ca0</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.95</span> <span class="o">*</span> <span class="n">k0</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="n">k0</span><span class="p">]:</span>
    <span class="n">sol</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">myode</span><span class="p">,</span> <span class="n">Ca0</span><span class="p">,</span> <span class="n">tspan</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">k</span><span class="p">,))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tspan</span><span class="p">,</span> <span class="n">sol</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;k=</span><span class="si">{0:1.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;At t=0.5 Ca = </span><span class="si">{0:1.2f}</span><span class="s1"> mol/L&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$C_A$ (mol/L)&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>At t=0.5 Ca = 0.77 mol/L
At t=0.5 Ca = 0.74 mol/L
At t=0.5 Ca = 0.70 mol/L
</pre></div>
</div>
<img alt="../_images/bc46b5a908a2609d83e035ebe478dd404807d335d88d2d7b8f3cfe209bdc19b2.png" src="../_images/bc46b5a908a2609d83e035ebe478dd404807d335d88d2d7b8f3cfe209bdc19b2.png" />
</div>
</div>
<p>You can see there are some variations in the concentration at t = 0.5. You could over or underestimate the concentration if you have the wrong estimate of <span class="math notranslate nohighlight">\(k\)</span>! You have to use some judgement here to decide how long to run the reaction to ensure a target goal is met.</p>
</section>
<section id="yet-another-way-to-parameterize-an-ode">
<h3>Yet another way to parameterize an ODE<a class="headerlink" href="#yet-another-way-to-parameterize-an-ode" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="http://matlab.cheme.cmu.edu/2011/11/06/yet-another-way-to-parameterize-an-ode/">Matlab post</a></p>
<p>We previously examined a way to parameterize an ODE. In those methods, we either used an anonymous function to parameterize an ode function, or we used a nested function that used variables from the shared workspace.</p>
<p>We want a convenient way to solve <span class="math notranslate nohighlight">\(dCa/dt = -k Ca\)</span> for multiple values of <span class="math notranslate nohighlight">\(k\)</span>. Here we use a trick to pass a parameter to an ODE through the initial conditions. We expand the ode function definition to include this parameter, and set its derivative to zero, effectively making it a constant.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">odeint</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ode</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">Ca</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">F</span>
    <span class="n">dCadt</span> <span class="o">=</span> <span class="o">-</span><span class="n">k</span> <span class="o">*</span> <span class="n">Ca</span>
    <span class="n">dkdt</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">dCadt</span><span class="p">,</span> <span class="n">dkdt</span><span class="p">]</span>

<span class="n">tspan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="n">Ca0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">K</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">K</span><span class="p">:</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">ode</span><span class="p">,</span> <span class="p">[</span><span class="n">Ca0</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">tspan</span><span class="p">)</span>
    <span class="n">Ca</span> <span class="o">=</span> <span class="n">F</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tspan</span><span class="p">,</span> <span class="n">Ca</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;k=</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$C_A$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/00ec39c1236c314ea30381b784c3529c4962f99aff5c2c80a168ac3863f61a61.png" src="../_images/00ec39c1236c314ea30381b784c3529c4962f99aff5c2c80a168ac3863f61a61.png" />
</div>
</div>
<p>I do not think this is a very elegant way to pass parameters around compared to the previous methods, but it nicely illustrates that there is more than one way to do it. And who knows, maybe it will be useful in some other context one day!</p>
</section>
<section id="another-way-to-parameterize-an-ode-nested-function">
<h3>Another way to parameterize an ODE - nested function<a class="headerlink" href="#another-way-to-parameterize-an-ode-nested-function" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="http://matlab.cheme.cmu.edu/2011/09/18/another-way-to-parameterize-an-ode-nested-function/">Matlab post</a></p>
<p>We saw one method to parameterize an ODE, by creating an ode function that takes an extra parameter argument, and then making a function handle that has the syntax required for the solver, and passes the parameter the ode function.</p>
<p>Here we define the ODE function in a loop. Since the nested function is in the namespace of the main function, it can “see” the values of the variables in the main function. We will use this method to look at the solution to the van der Pol equation for several different values of mu.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">odeint</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">MU</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="n">tspan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span>
<span class="n">Y0</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

<span class="k">for</span> <span class="n">mu</span> <span class="ow">in</span> <span class="n">MU</span><span class="p">:</span>
    <span class="c1"># define the ODE</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">vdpol</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">Y</span>
        <span class="n">dxdt</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">dydt</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span>
        <span class="k">return</span>  <span class="p">[</span><span class="n">dxdt</span><span class="p">,</span> <span class="n">dydt</span><span class="p">]</span>

    <span class="n">Y</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">vdpol</span><span class="p">,</span> <span class="n">Y0</span><span class="p">,</span> <span class="n">tspan</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[:,</span><span class="mi">0</span><span class="p">];</span> <span class="n">y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;mu=</span><span class="si">{0:1.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/36a01f8a4893b6431156323b07e434d6145afef12b081df5f7d83ef602e733c0.png" src="../_images/36a01f8a4893b6431156323b07e434d6145afef12b081df5f7d83ef602e733c0.png" />
</div>
</div>
<p>You can see the solution changes dramatically for different values of mu. The point here is not to understand why, but to show an easy way to study a parameterize ode with a nested function. Nested functions can be a great way to “share” variables between functions especially for ODE solving, and nonlinear algebra solving, or any other application where you need a lot of parameters defined in one function in another function.</p>
</section>
<section id="solving-a-second-order-ode">
<h3>Solving a second order ode<a class="headerlink" href="#solving-a-second-order-ode" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="http://matlab.cheme.cmu.edu/2011/09/26/solving-a-second-order-ode/">Matlab post</a></p>
<p>The odesolvers in scipy can only solve first order ODEs, or systems of first order ODES. To solve a second order ODE, we must convert it by changes of variables to a system of first order ODES. We consider the Van der Pol oscillator here:</p>
<div class="math notranslate nohighlight">
\[\frac{d^2x}{dt^2} - \mu(1-x^2)\frac{dx}{dt} + x = 0\]</div>
<p><span class="math notranslate nohighlight">\(\mu\)</span> is a constant. If we let <span class="math notranslate nohighlight">\(y=x - x^3/3\)</span> <a class="reference external" href="http://en.wikipedia.org/wiki/Van_der_Pol_oscillator">http://en.wikipedia.org/wiki/Van_der_Pol_oscillator</a>, then we arrive at this set of equations:</p>
<div class="math notranslate nohighlight">
\[\frac{dx}{dt} = \mu(x-1/3x^3-y)\]</div>
<div class="math notranslate nohighlight">
\[\frac{dy}{dt} = \mu/x\]</div>
<p>here is how we solve this set of equations. Let <span class="math notranslate nohighlight">\(\mu=1\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">odeint</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">mu</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">vanderpol</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dxdt</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">dydt</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">mu</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">dxdt</span><span class="p">,</span> <span class="n">dydt</span><span class="p">]</span>

<span class="n">X0</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">250</span><span class="p">)</span>

<span class="n">sol</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">vanderpol</span><span class="p">,</span> <span class="n">X0</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">))</span>

<span class="c1"># phase portrait</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0d573cac75edb8dc10186fb717e8cd4a2a102b7b3efee72a0cd142fb97025b82.png" src="../_images/0d573cac75edb8dc10186fb717e8cd4a2a102b7b3efee72a0cd142fb97025b82.png" />
<img alt="../_images/e2ec3efaf218cc78237e6f5fdcad226957ce93c1c21ba1569c7f4fecb477ebcb.png" src="../_images/e2ec3efaf218cc78237e6f5fdcad226957ce93c1c21ba1569c7f4fecb477ebcb.png" />
</div>
</div>
<p>Here is the phase portrait. You can see that a limit cycle is approached, indicating periodicity in the solution.</p>
</section>
<section id="solving-bessel-s-equation-numerically">
<h3>Solving Bessel’s Equation numerically<a class="headerlink" href="#solving-bessel-s-equation-numerically" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="http://matlab.cheme.cmu.edu/2011/08/08/solving-bessels-equation-numerically/">Matlab post</a></p>
<p>Reference Ch 5.5 Kreysig, Advanced Engineering Mathematics, 9th ed.</p>
<p>Bessel’s equation <span class="math notranslate nohighlight">\(x^2 y'' + x y' + (x^2 - \nu^2)y=0\)</span> comes up often in engineering problems such as heat transfer. The solutions to this equation are the Bessel functions. To solve this equation numerically, we must convert it to a system of first order ODEs. This can be done by letting <span class="math notranslate nohighlight">\(z = y'\)</span> and <span class="math notranslate nohighlight">\(z' = y''\)</span> and performing the change of variables:</p>
<div class="math notranslate nohighlight">
\[ y' = z\]</div>
<div class="math notranslate nohighlight">
\[ z' = \frac{1}{x^2}(-x z - (x^2 - \nu^2) y\]</div>
<p>if we take the case where <span class="math notranslate nohighlight">\(\nu = 0\)</span>, the solution is known to be the Bessel function <span class="math notranslate nohighlight">\(J_0(x)\)</span>, which is represented in Matlab as besselj(0,x). The initial conditions for this problem are: <span class="math notranslate nohighlight">\(y(0) = 1\)</span> and <span class="math notranslate nohighlight">\(y'(0)=0\)</span>.</p>
<p>There is a problem with our system of ODEs at x=0. Because of the <span class="math notranslate nohighlight">\(1/x^2\)</span> term, the ODEs are not defined at x=0. If we start very close to zero instead, we avoid the problem.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">odeint</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.special</span><span class="w"> </span><span class="kn">import</span> <span class="n">jn</span> <span class="c1"># bessel function</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fbessel</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">dydx</span> <span class="o">=</span> <span class="n">z</span>
    <span class="n">dzdx</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">x</span> <span class="o">*</span> <span class="n">z</span> <span class="o">-</span> <span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">nu</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">dydx</span><span class="p">,</span> <span class="n">dzdx</span><span class="p">]</span>

<span class="n">x0</span> <span class="o">=</span> <span class="mf">1e-15</span>
<span class="n">y0</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">z0</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">Y0</span> <span class="o">=</span> <span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">]</span>

<span class="n">xspan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1e-15</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">fbessel</span><span class="p">,</span> <span class="n">Y0</span><span class="p">,</span> <span class="n">xspan</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xspan</span><span class="p">,</span> <span class="n">sol</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;numerical soln&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xspan</span><span class="p">,</span> <span class="n">jn</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xspan</span><span class="p">),</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Bessel&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b8718fa118704a1294f74c9c860be4151959eb7f39d54a969fd482432da49151.png" src="../_images/b8718fa118704a1294f74c9c860be4151959eb7f39d54a969fd482432da49151.png" />
</div>
</div>
<p>You can see the numerical and analytical solutions overlap, indicating they are at least visually the same.</p>
</section>
<section id="phase-portraits-of-a-system-of-odes">
<h3>Phase portraits of a system of ODEs<a class="headerlink" href="#phase-portraits-of-a-system-of-odes" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="http://matlab.cheme.cmu.edu/2011/08/09/phase-portraits-of-a-system-of-odes/">Matlab post</a>
An undamped pendulum with no driving force is described by</p>
<div class="math notranslate nohighlight">
\[ y'' + sin(y) = 0\]</div>
<p>We reduce this to standard matlab form of a system of first order ODEs by letting <span class="math notranslate nohighlight">\(y_1 = y\)</span> and <span class="math notranslate nohighlight">\(y_2=y_1'\)</span>. This leads to:</p>
<p><span class="math notranslate nohighlight">\(y_1' = y_2\)</span></p>
<p><span class="math notranslate nohighlight">\(y_2' = -sin(y_1)\)</span></p>
<p>The phase portrait is a plot of a vector field which qualitatively shows how the solutions to these equations will go from a given starting point. here is our definition of the differential equations:</p>
<p>To generate the phase portrait, we need to compute the derivatives <span class="math notranslate nohighlight">\(y_1'\)</span> and <span class="math notranslate nohighlight">\(y_2'\)</span> at <span class="math notranslate nohighlight">\(t=0\)</span> on a grid over the range of values for <span class="math notranslate nohighlight">\(y_1\)</span> and <span class="math notranslate nohighlight">\(y_2\)</span> we are interested in. We will plot the derivatives as a vector at each (y1, y2) which will show us the initial direction from each point. We will examine the solutions over the range -2 &lt; y1 &lt; 8, and -2 &lt; y2 &lt; 2 for y2, and create a grid of 20 x 20 points.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">Y</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">y2</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">y1</span><span class="p">)]</span>

<span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>

<span class="n">Y1</span><span class="p">,</span> <span class="n">Y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>

<span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Y1</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Y2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">NI</span><span class="p">,</span> <span class="n">NJ</span> <span class="o">=</span> <span class="n">Y1</span><span class="o">.</span><span class="n">shape</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NI</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NJ</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">Y1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">Y2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
        <span class="n">yprime</span> <span class="o">=</span> <span class="n">f</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">yprime</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">yprime</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


<span class="n">Q</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">Y1</span><span class="p">,</span> <span class="n">Y2</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;$y_1$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$y_2$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/81218c54be029e16215fa608bd7088b53c679df377e12fea7197c785920fcb2a.png" src="../_images/81218c54be029e16215fa608bd7088b53c679df377e12fea7197c785920fcb2a.png" />
</div>
</div>
<p>Let us plot a few solutions on the vector field. We will consider the solutions where y1(0)=0, and values of y2(0) = [0 0.5 1 1.5 2 2.5], in otherwords we start the pendulum at an angle of zero, with some angular velocity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">odeint</span>

<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="k">for</span> <span class="n">y20</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">]:</span>
    <span class="n">tspan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">y20</span><span class="p">]</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">tspan</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ys</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">ys</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">)</span> <span class="c1"># path</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">ys</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">ys</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span> <span class="c1"># start</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">ys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">ys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span> <span class="c1"># end</span>


<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9b8af47a7a8328880ef0de7894b02be630ed43836a93d6f41339ff3a5643b2e0.png" src="../_images/9b8af47a7a8328880ef0de7894b02be630ed43836a93d6f41339ff3a5643b2e0.png" />
</div>
</div>
<p>What do these figures mean? For starting points near the origin, and small velocities, the pendulum goes into a stable limit cycle. For others, the trajectory appears to fly off into y1 space. Recall that y1 is an angle that has values from <span class="math notranslate nohighlight">\(-\pi\)</span> to <span class="math notranslate nohighlight">\(\pi\)</span>. The y1 data in this case is not wrapped around to be in this range.</p>
</section>
<section id="linear-algebra-approaches-to-solving-systems-of-constant-coefficient-odes">
<h3>Linear algebra approaches to solving systems of constant coefficient ODEs<a class="headerlink" href="#linear-algebra-approaches-to-solving-systems-of-constant-coefficient-odes" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="http://matlab.cheme.cmu.edu/2011/10/20/linear-algebra-approaches-to-solving-systems-of-constant-coefficient-odes">Matlab post</a></p>
<p>Today we consider how to solve a system of first order, constant coefficient ordinary differential equations using linear algebra. These equations could be solved numerically, but in this case there are analytical solutions that can be derived. The equations we will solve are:</p>
<p><span class="math notranslate nohighlight">\(y'_1 = -0.02 y_1 + 0.02 y_2\)</span></p>
<p><span class="math notranslate nohighlight">\(y'_2 = 0.02 y_1 - 0.02 y_2\)</span></p>
<p>We can express this set of equations in matrix form as: <span class="math notranslate nohighlight">\(\left[\begin{array}{c}y'_1\\y'_2\end{array}\right] = \left[\begin{array}{cc} -0.02 &amp; 0.02 \\ 0.02 &amp; -0.02\end{array}\right] \left[\begin{array}{c}y_1\\y_2\end{array}\right]\)</span></p>
<p>The general solution to this set of equations is</p>
<p><span class="math notranslate nohighlight">\(\left[\begin{array}{c}y_1\\y_2\end{array}\right] = \left[\begin{array}{cc}v_1 &amp; v_2\end{array}\right] \left[\begin{array}{cc} c_1 &amp; 0 \\ 0 &amp; c_2\end{array}\right] \exp\left(\left[\begin{array}{cc} \lambda_1 &amp; 0 \\ 0 &amp; \lambda_2\end{array}\right] \left[\begin{array}{c}t\\t\end{array}\right]\right)\)</span></p>
<p>where <span class="math notranslate nohighlight">\(\left[\begin{array}{cc} \lambda_1 &amp; 0 \\ 0 &amp; \lambda_2\end{array}\right]\)</span> is a diagonal matrix of the eigenvalues of the constant coefficient matrix, <span class="math notranslate nohighlight">\(\left[\begin{array}{cc}v_1 &amp; v_2\end{array}\right]\)</span> is a matrix of eigenvectors where the <span class="math notranslate nohighlight">\(i^{th}\)</span> column corresponds to the eigenvector of the <span class="math notranslate nohighlight">\(i^{th}\)</span> eigenvalue, and <span class="math notranslate nohighlight">\(\left[\begin{array}{cc} c_1 &amp; 0 \\ 0 &amp; c_2\end{array}\right]\)</span> is a matrix determined by the initial conditions.</p>
<p>In this example, we evaluate the solution using linear algebra. The initial conditions we will consider are <span class="math notranslate nohighlight">\(y_1(0)=0\)</span> and <span class="math notranslate nohighlight">\(y_2(0)=150\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.02</span><span class="p">,</span>  <span class="mf">0.02</span><span class="p">],</span>
              <span class="p">[</span> <span class="mf">0.02</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.02</span><span class="p">]])</span>

<span class="c1"># Return the eigenvalues and eigenvectors of a Hermitian or symmetric matrix.</span>
<span class="n">evals</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evals</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">evecs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[-0.04  0.  ]
[[ 0.70710678  0.70710678]
 [-0.70710678  0.70710678]]
</pre></div>
</div>
</div>
</div>
<p>The eigenvectors are the <em>columns</em> of evecs.</p>
<p>Compute the <span class="math notranslate nohighlight">\(c\)</span> matrix</p>
<p>V*c = Y0</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Y0</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">150</span><span class="p">]</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">evecs</span><span class="p">,</span> <span class="n">Y0</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[-106.06601718    0.        ]
 [   0.          106.06601718]]
</pre></div>
</div>
</div>
</div>
<p>Constructing the solution</p>
<p>We will create a vector of time values, and stack them for each solution, <span class="math notranslate nohighlight">\(y_1(t)\)</span> and <span class="math notranslate nohighlight">\(Y_2(t)\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">row_stack</span><span class="p">([</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">])</span>

<span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">evals</span><span class="p">)</span>

<span class="c1"># y = V*c*exp(D*T);</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">evecs</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">T</span><span class="p">)))</span>

<span class="c1"># y has a shape of (2, 50) so we have to transpose it</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;$y_1$&#39;</span><span class="p">,</span> <span class="s1">&#39;$y_2$&#39;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_2204/2289625004.py:4: DeprecationWarning: `row_stack` alias is deprecated. Use `np.vstack` directly.
  T = np.row_stack([t, t])
</pre></div>
</div>
<img alt="../_images/b84c7821adf06799937812bd439aeb9852936c8f505267c80f0a5e47bf568de9.png" src="../_images/b84c7821adf06799937812bd439aeb9852936c8f505267c80f0a5e47bf568de9.png" />
</div>
</div>
</section>
</section>
<section id="delay-differential-equations">
<h2>Delay Differential Equations<a class="headerlink" href="#delay-differential-equations" title="Link to this heading">#</a></h2>
<p>In Matlab you can solve Delay Differential equations (DDE) (<a class="reference external" href="http://matlab.cheme.cmu.edu/2011/09/28/delay-differential-equations/">Matlab post</a>). I do not know of a solver in scipy at this time that can do this.</p>
</section>
<section id="differential-algebraic-systems-of-equations">
<h2>Differential algebraic systems of equations<a class="headerlink" href="#differential-algebraic-systems-of-equations" title="Link to this heading">#</a></h2>
<p>There is not a builtin solver for DAE systems in scipy. It looks like <a class="reference external" href="http://pysundials.sourceforge.net/">pysundials</a> may do it, but it must be compiled and installed.</p>
</section>
<section id="boundary-value-equations">
<h2>Boundary value equations<a class="headerlink" href="#boundary-value-equations" title="Link to this heading">#</a></h2>
<p>In the following examples we implement some approaches to solving certain types of linear BVPs.</p>
<p>scipy.integrate.solve_bvp now exists.</p>
<section id="plane-poiseuille-flow-bvp-solve-by-shooting-method">
<h3>Plane Poiseuille flow - BVP solve by shooting method<a class="headerlink" href="#plane-poiseuille-flow-bvp-solve-by-shooting-method" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="http://matlab.cheme.cmu.edu/2011/09/08/plane-poiseuille-flow-bvp-solve-by-shooting-method/">Matlab post</a></p>
<p>One approach to solving BVPs is to use the shooting method. The reason we cannot use an initial value solver for a BVP is that there is not enough information at the initial value to start. In the shooting method, we take the function value at the initial point, and guess what the function derivatives are so that we can do an integration. If our guess was good, then the solution will go through the known second boundary point. If not, we guess again, until we get the answer we need. In this example we repeat the pressure driven flow example, but illustrate the shooting method.</p>
<p>In the pressure driven flow of a fluid with viscosity <span class="math notranslate nohighlight">\(\mu\)</span> between two stationary plates separated by distance <span class="math notranslate nohighlight">\(d\)</span> and driven by a pressure drop <span class="math notranslate nohighlight">\(\Delta P/\Delta x\)</span>, the governing equations on the velocity <span class="math notranslate nohighlight">\(u\)</span> of the fluid are (assuming flow in the x-direction with the velocity varying only in the y-direction):</p>
<div class="math notranslate nohighlight">
\[\frac{\Delta P}{\Delta x} = \mu \frac{d^2u}{dy^2}\]</div>
<p>with boundary conditions <span class="math notranslate nohighlight">\(u(y=0) = 0\)</span> and <span class="math notranslate nohighlight">\(u(y=d) = 0\)</span>, i.e. the no-slip condition at the edges of the plate.</p>
<p>we convert this second order BVP to a system of ODEs by letting <span class="math notranslate nohighlight">\(u_1 = u\)</span>, <span class="math notranslate nohighlight">\(u_2 = u_1'\)</span> and then <span class="math notranslate nohighlight">\(u_2' = u_1''\)</span>. This leads to:</p>
<p><span class="math notranslate nohighlight">\(\frac{d u_1}{dy} = u_2\)</span></p>
<p><span class="math notranslate nohighlight">\(\frac{d u_2}{dy} = \frac{1}{\mu}\frac{\Delta P}{\Delta x}\)</span></p>
<p>with boundary conditions <span class="math notranslate nohighlight">\(u_1(y=0) = 0\)</span> and <span class="math notranslate nohighlight">\(u_1(y=d) = 0\)</span>.</p>
<p>for this problem we let the plate separation be d=0.1, the viscosity <span class="math notranslate nohighlight">\(\mu = 1\)</span>, and <span class="math notranslate nohighlight">\(\frac{\Delta P}{\Delta x} = -100\)</span>.</p>
<section id="first-guess">
<h4>First guess<a class="headerlink" href="#first-guess" title="Link to this heading">#</a></h4>
<p>We need u_1(0) and u_2(0), but we only have u_1(0). We need to guess a value for u_2(0) and see if the solution goes through the u_2(d)=0 boundary value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">odeint</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">d</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># plate thickness</span>

<span class="k">def</span><span class="w"> </span><span class="nf">odefun</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">u1</span><span class="p">,</span> <span class="n">u2</span> <span class="o">=</span> <span class="n">U</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">Pdrop</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
    <span class="n">du1dy</span> <span class="o">=</span> <span class="n">u2</span>
    <span class="n">du2dy</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">Pdrop</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">du1dy</span><span class="p">,</span> <span class="n">du2dy</span><span class="p">]</span>

<span class="n">u1_0</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># known</span>
<span class="n">u2_0</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># guessed</span>

<span class="n">dspan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

<span class="n">U</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">odefun</span><span class="p">,</span> <span class="p">[</span><span class="n">u1_0</span><span class="p">,</span> <span class="n">u2_0</span><span class="p">],</span> <span class="n">dspan</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dspan</span><span class="p">,</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">d</span><span class="p">],[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$u_1$&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/35a378860882acdfda626d6d4b252a68f76085c1c2c73cae2c94b1a4b25f9edd.png" src="../_images/35a378860882acdfda626d6d4b252a68f76085c1c2c73cae2c94b1a4b25f9edd.png" />
</div>
</div>
<p>Here we have undershot the boundary condition. Let us try a larger guess.</p>
</section>
<section id="second-guess">
<h4>Second guess<a class="headerlink" href="#second-guess" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">u1_0</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># known</span>
<span class="n">u2_0</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># guessed</span>

<span class="n">dspan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

<span class="n">U</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">odefun</span><span class="p">,</span> <span class="p">[</span><span class="n">u1_0</span><span class="p">,</span> <span class="n">u2_0</span><span class="p">],</span> <span class="n">dspan</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dspan</span><span class="p">,</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">d</span><span class="p">],[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$u_1$&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/54d47c21f5ac51d7d64cdf10163bba59cc93b8865f6f7bf39e13227198d1a299.png" src="../_images/54d47c21f5ac51d7d64cdf10163bba59cc93b8865f6f7bf39e13227198d1a299.png" />
</div>
</div>
<p>Now we have clearly overshot. Let us now make a function that will iterate for us to find the right value.</p>
</section>
<section id="let-fsolve-do-the-work">
<h4>Let fsolve do the work<a class="headerlink" href="#let-fsolve-do-the-work" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">fsolve</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">Pdrop</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>

<span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">u2_0</span><span class="p">):</span>
    <span class="n">dspan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">odefun</span><span class="p">,</span> <span class="p">[</span><span class="n">u1_0</span><span class="p">,</span> <span class="n">u2_0</span><span class="p">],</span> <span class="n">dspan</span><span class="p">)</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">u1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">u2_0</span><span class="p">,</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># now solve with optimal u2_0</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">odefun</span><span class="p">,</span> <span class="p">[</span><span class="n">u1_0</span><span class="p">,</span> <span class="n">u2_0</span><span class="p">],</span> <span class="n">dspan</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dspan</span><span class="p">,</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Numerical solution&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">d</span><span class="p">],[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>

<span class="c1"># plot an analytical solution</span>
<span class="n">u</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">Pdrop</span><span class="p">)</span> <span class="o">*</span> <span class="n">d</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dspan</span> <span class="o">/</span> <span class="n">d</span> <span class="o">-</span> <span class="p">(</span><span class="n">dspan</span> <span class="o">/</span> <span class="n">d</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dspan</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Analytical solution&#39;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$u_1$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">29</span><span class="p">],</span> <span class="n">line</span> <span class="mi">12</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span>     <span class="n">u1</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span>     <span class="k">return</span> <span class="n">u1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="ne">---&gt; </span><span class="mi">12</span> <span class="n">u2_0</span><span class="p">,</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span> <span class="c1"># now solve with optimal u2_0</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span> <span class="n">U</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">odefun</span><span class="p">,</span> <span class="p">[</span><span class="n">u1_0</span><span class="p">,</span> <span class="n">u2_0</span><span class="p">],</span> <span class="n">dspan</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/scipy/optimize/_minpack_py.py:171,</span> in <span class="ni">fsolve</span><span class="nt">(func, x0, args, fprime, full_output, col_deriv, xtol, maxfev, band, epsfcn, factor, diag)</span>
<span class="g g-Whitespace">    </span><span class="mi">161</span> <span class="n">_wrapped_func</span><span class="o">.</span><span class="n">nfev</span> <span class="o">=</span> <span class="mi">0</span>
<span class="g g-Whitespace">    </span><span class="mi">163</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;col_deriv&#39;</span><span class="p">:</span> <span class="n">col_deriv</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">164</span>            <span class="s1">&#39;xtol&#39;</span><span class="p">:</span> <span class="n">xtol</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">165</span>            <span class="s1">&#39;maxfev&#39;</span><span class="p">:</span> <span class="n">maxfev</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>    <span class="mi">168</span>            <span class="s1">&#39;factor&#39;</span><span class="p">:</span> <span class="n">factor</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">169</span>            <span class="s1">&#39;diag&#39;</span><span class="p">:</span> <span class="n">diag</span><span class="p">}</span>
<span class="ne">--&gt; </span><span class="mi">171</span> <span class="n">res</span> <span class="o">=</span> <span class="n">_root_hybr</span><span class="p">(</span><span class="n">_wrapped_func</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">fprime</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">172</span> <span class="n">res</span><span class="o">.</span><span class="n">nfev</span> <span class="o">=</span> <span class="n">_wrapped_func</span><span class="o">.</span><span class="n">nfev</span>
<span class="g g-Whitespace">    </span><span class="mi">174</span> <span class="k">if</span> <span class="n">full_output</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/scipy/optimize/_minpack_py.py:239,</span> in <span class="ni">_root_hybr</span><span class="nt">(func, x0, args, jac, col_deriv, xtol, maxfev, band, eps, factor, diag, **unknown_options)</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">238</span>     <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="p">,)</span>
<span class="ne">--&gt; </span><span class="mi">239</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">_check_func</span><span class="p">(</span><span class="s1">&#39;fsolve&#39;</span><span class="p">,</span> <span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,))</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span> <span class="k">if</span> <span class="n">epsfcn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>     <span class="n">epsfcn</span> <span class="o">=</span> <span class="n">finfo</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/scipy/optimize/_minpack_py.py:24,</span> in <span class="ni">_check_func</span><span class="nt">(checker, argname, thefunc, x0, args, numinputs, output_shape)</span>
<span class="g g-Whitespace">     </span><span class="mi">22</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_func</span><span class="p">(</span><span class="n">checker</span><span class="p">,</span> <span class="n">argname</span><span class="p">,</span> <span class="n">thefunc</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">numinputs</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">23</span>                 <span class="n">output_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">24</span>     <span class="n">res</span> <span class="o">=</span> <span class="n">atleast_1d</span><span class="p">(</span><span class="n">thefunc</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">x0</span><span class="p">[:</span><span class="n">numinputs</span><span class="p">],)</span> <span class="o">+</span> <span class="n">args</span><span class="p">)))</span>
<span class="g g-Whitespace">     </span><span class="mi">25</span>     <span class="k">if</span> <span class="p">(</span><span class="n">output_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">shape</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">!=</span> <span class="n">output_shape</span><span class="p">):</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span>         <span class="k">if</span> <span class="p">(</span><span class="n">output_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/scipy/optimize/_minpack_py.py:159,</span> in <span class="ni">fsolve.&lt;locals&gt;._wrapped_func</span><span class="nt">(*fargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">154</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">155</span><span class="sd"> Wrapped `func` to track the number of times</span>
<span class="g g-Whitespace">    </span><span class="mi">156</span><span class="sd"> the function has been called.</span>
<span class="g g-Whitespace">    </span><span class="mi">157</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">158</span> <span class="n">_wrapped_func</span><span class="o">.</span><span class="n">nfev</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="ne">--&gt; </span><span class="mi">159</span> <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">fargs</span><span class="p">)</span>

<span class="nn">Cell In[29], line 8,</span> in <span class="ni">objective</span><span class="nt">(u2_0)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">u2_0</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>     <span class="n">dspan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">8</span>     <span class="n">U</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">odefun</span><span class="p">,</span> <span class="p">[</span><span class="n">u1_0</span><span class="p">,</span> <span class="n">u2_0</span><span class="p">],</span> <span class="n">dspan</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span>     <span class="n">u1</span> <span class="o">=</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span>     <span class="k">return</span> <span class="n">u1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/scipy/integrate/_odepack_py.py:254,</span> in <span class="ni">odeint</span><span class="nt">(func, y0, t, args, Dfun, col_deriv, full_output, ml, mu, rtol, atol, tcrit, h0, hmax, hmin, ixpr, mxstep, mxhnil, mxordn, mxords, printmessg, tfirst)</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">y0</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">253</span> <span class="k">with</span> <span class="n">ODE_LOCK</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">254</span>     <span class="n">output</span> <span class="o">=</span> <span class="n">_odepack</span><span class="o">.</span><span class="n">odeint</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">Dfun</span><span class="p">,</span> <span class="n">col_deriv</span><span class="p">,</span> <span class="n">ml</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">255</span>                             <span class="n">full_output</span><span class="p">,</span> <span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="p">,</span> <span class="n">tcrit</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">hmax</span><span class="p">,</span> <span class="n">hmin</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">256</span>                             <span class="n">ixpr</span><span class="p">,</span> <span class="n">mxstep</span><span class="p">,</span> <span class="n">mxhnil</span><span class="p">,</span> <span class="n">mxordn</span><span class="p">,</span> <span class="n">mxords</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">257</span>                             <span class="nb">int</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">tfirst</span><span class="p">)))</span>
<span class="g g-Whitespace">    </span><span class="mi">258</span> <span class="k">if</span> <span class="n">output</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">259</span>     <span class="n">warning_msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_msgs</span><span class="p">[</span><span class="n">output</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="si">}</span><span class="s2"> Run with full_output = 1 to &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">260</span>                    <span class="sa">f</span><span class="s2">&quot;get quantitative information.&quot;</span><span class="p">)</span>

<span class="ne">ValueError</span>: setting an array element with a sequence. The requested array has an inhomogeneous shape after 1 dimensions. The detected shape was (2,) + inhomogeneous part.
</pre></div>
</div>
</div>
</div>
<p>You can see the agreement is excellent!</p>
</section>
</section>
<section id="plane-poiseuelle-flow-solved-by-finite-difference">
<h3>Plane poiseuelle flow solved by finite difference<a class="headerlink" href="#plane-poiseuelle-flow-solved-by-finite-difference" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="http://matlab.cheme.cmu.edu/2011/09/30/plane-poiseuelle-flow-solved-by-finite-difference/">Matlab post</a></p>
<p>Adapted from <a class="reference external" href="http://www.physics.arizona.edu/~restrepo/475B/Notes/sourcehtml/node24.html">http://www.physics.arizona.edu/~restrepo/475B/Notes/sourcehtml/node24.html</a></p>
<p>We want to solve a linear boundary value problem of the form: y’’ = p(x)y’ + q(x)y + r(x) with boundary conditions y(x1) = alpha and y(x2) = beta.</p>
<p>For this example, we solve the plane poiseuille flow problem using a finite difference approach. An advantage of the approach we use here is we do not have to rewrite the second order ODE as a set of coupled first order ODEs, nor do we have to provide guesses for the solution. We do, however, have to discretize the derivatives and formulate a linear algebra problem.</p>
<p>we want to solve u’’ = 1/mu*DPDX with u(0)=0 and u(0.1)=0. for this problem we let the plate separation be d=0.1, the viscosity <span class="math notranslate nohighlight">\(\mu = 1\)</span>, and <span class="math notranslate nohighlight">\(\frac{\Delta P}{\Delta x} = -100\)</span>.</p>
<p>The idea behind the finite difference method is to approximate the derivatives by finite differences on a grid. See here for details. By discretizing the ODE, we arrive at a set of linear algebra equations of the form <span class="math notranslate nohighlight">\(A y = b\)</span>, where <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(b\)</span> are defined as follows.</p>
<div class="math notranslate nohighlight">
\[\begin{split}A = \left [ \begin{array}{ccccc} %
 2 + h^2 q_1         &amp; -1 + \frac{h}{2} p_1 &amp; 0                    &amp; 0 &amp; 0 \\
-1 - \frac{h}{2} p_2 &amp; 2 + h^2 q_2          &amp; -1 + \frac{h}{2} p_2 &amp; 0 &amp; 0 \\
0                    &amp; \ddots               &amp; \ddots               &amp; \ddots &amp; 0 \\
0                    &amp; 0                    &amp; -1 - \frac{h}{2} p_{N-1} &amp; 2 + h^2 q_{N-1} &amp; -1 + \frac{h}{2} p_{N-1} \\
0                    &amp; 0                    &amp; 0  &amp; -1 - \frac{h}{2} p_N &amp; 2 + h^2 q_N \end{array} \right ] \end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split} y = \left [ \begin{array}{c} y_i \\ \vdots \\ y_N \end{array} \right ] \end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split} b = \left [ \begin{array}{c} -h^2 r_1 + ( 1 + \frac{h}{2} p_1) \alpha \\
-h^2 r_2 \\
\vdots \\
-h^2 r_{N-1} \\
-h^2 r_N + (1 - \frac{h}{2} p_N) \beta \end{array} \right] \end{split}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># we use the notation for y&#39;&#39; = p(x)y&#39; + q(x)y + r(x)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">p</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">q</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">r</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">100</span>

<span class="c1">#we use the notation y(x1) = alpha and y(x2) = beta</span>

<span class="n">x1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">x2</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span> <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="n">npoints</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># compute interval width</span>
<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">/</span><span class="n">npoints</span><span class="p">;</span>

<span class="c1"># preallocate and shape the b vector and A-matrix</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">npoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>

<span class="c1">#now we populate the A-matrix and b vector elements</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span>

    <span class="c1"># get the value of the BVP Odes at this x</span>
    <span class="n">pi</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">qi</span> <span class="o">=</span> <span class="n">q</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">ri</span> <span class="o">=</span> <span class="n">r</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># first boundary condition</span>
        <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ri</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">alpha</span><span class="p">;</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">npoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># second boundary condition</span>
        <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ri</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">beta</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ri</span> <span class="c1"># intermediate points</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span> <span class="c1"># the diagonal</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">h</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">qi</span>
        <span class="k">elif</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># left of the diagonal</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span>
        <span class="k">elif</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># right of the diagonal</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># off the tri-diagonal</span>

<span class="c1"># solve the equations A*y = b for Y</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">x2</span><span class="p">])</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Y</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">beta</span><span class="p">])</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">mu</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">d</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.1</span><span class="p">);</span>
<span class="n">Pdrop</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span> <span class="c1"># this is DeltaP/Deltax</span>
<span class="n">u</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">Pdrop</span><span class="p">)</span> <span class="o">*</span> <span class="n">d</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">d</span> <span class="o">-</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">d</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;r--&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;distance between plates&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;fluid velocity&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s1">&#39;finite difference&#39;</span><span class="p">,</span> <span class="s1">&#39;analytical soln&#39;</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ba9ca5600a79a71a84d23c1added2e68565943f60b4ff0b1e471f2ebf372b288.png" src="../_images/ba9ca5600a79a71a84d23c1added2e68565943f60b4ff0b1e471f2ebf372b288.png" />
</div>
</div>
<p>You can see excellent agreement here between the numerical and analytical solution.</p>
</section>
<section id="boundary-value-problem-in-heat-conduction">
<h3>Boundary value problem in heat conduction<a class="headerlink" href="#boundary-value-problem-in-heat-conduction" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="http://matlab.cheme.cmu.edu/2011/08/11/boundary-value-problem-in-heat-conduction/">Matlab post</a></p>
<p>For steady state heat conduction the temperature distribution in one-dimension is governed by the Laplace equation:</p>
<div class="math notranslate nohighlight">
\[ \nabla^2 T = 0\]</div>
<p>with boundary conditions that at <span class="math notranslate nohighlight">\(T(x=a) = T_A\)</span> and <span class="math notranslate nohighlight">\(T(x=L) = T_B\)</span>.</p>
<p>The analytical solution is not difficult here: <span class="math notranslate nohighlight">\(T = T_A-\frac{T_A-T_B}{L}x\)</span>, but we will solve this by finite differences.</p>
<p>For this problem, lets consider a slab that is defined by x=0 to x=L, with <span class="math notranslate nohighlight">\(T(x=0) = 100\)</span>, and <span class="math notranslate nohighlight">\(T(x=L) = 200\)</span>. We want to find the function T(x) inside the slab.</p>
<p>We approximate the second derivative by finite differences as</p>
<p><span class="math notranslate nohighlight">\( f''(x) \approx \frac{f(x-h) - 2 f(x) + f(x+h)}{h^2} \)</span></p>
<p>Since the second derivative in this case is equal to zero, we have at each discretized node <span class="math notranslate nohighlight">\(0 = T_{i-1} - 2 T_i + T_{i+1}\)</span>. We know the values of <span class="math notranslate nohighlight">\(T_{x=0} = \alpha\)</span> and <span class="math notranslate nohighlight">\(T_{x=L} = \beta\)</span>.</p>
<div class="math notranslate nohighlight">
\[\begin{split}A = \left [ \begin{array}{ccccc} %
 -2         &amp; 1 &amp; 0                    &amp; 0 &amp; 0 \\
1           &amp; -2&amp; 1 &amp; 0 &amp; 0 \\
0                    &amp; \ddots               &amp; \ddots               &amp; \ddots &amp; 0 \\
0                    &amp; 0                    &amp; 1 &amp; -2 &amp; 1 \\
0                    &amp; 0                    &amp; 0  &amp; 1  &amp; -2  \end{array} \right ] \end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split} x = \left [ \begin{array}{c} T_1 \\ \vdots \\ T_N \end{array} \right ] \end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split} b = \left [ \begin{array}{c} -T(x=0) \\
0 \\
\vdots \\
0 \\
-T(x=L) \end{array} \right] \end{split}\]</div>
<p>These are linear equations in the unknowns <span class="math notranslate nohighlight">\(x\)</span> that we can easily solve. Here, we evaluate the solution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1">#we use the notation T(x1) = alpha and T(x2) = beta</span>
<span class="n">x1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">x2</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">beta</span> <span class="o">=</span> <span class="mi">200</span>

<span class="n">npoints</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># preallocate and shape the b vector and A-matrix</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npoints</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">alpha</span>
<span class="n">b</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">beta</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npoints</span><span class="p">,</span> <span class="n">npoints</span><span class="p">));</span>

<span class="c1">#now we populate the A-matrix and b vector elements</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npoints</span> <span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npoints</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span> <span class="c1"># the diagonal</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
        <span class="k">elif</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># left of the diagonal</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># right of the diagonal</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># solve the equations A*y = b for Y</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">npoints</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Y</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">beta</span><span class="p">])</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;T(X)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">((</span><span class="s1">&#39;finite difference&#39;</span><span class="p">,</span> <span class="s1">&#39;analytical soln&#39;</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ffdc9687c1088173ced514ecaa116a11a2a989b08a2cb9a2b3b3a1d1aff6faf1.png" src="../_images/ffdc9687c1088173ced514ecaa116a11a2a989b08a2cb9a2b3b3a1d1aff6faf1.png" />
</div>
</div>
</section>
<section id="a-nonlinear-bvp">
<h3>A nonlinear BVP<a class="headerlink" href="#a-nonlinear-bvp" title="Link to this heading">#</a></h3>
<p>Adapted from Example 8.7 in <u>Numerical Methods in Engineering with Python</u> by Jaan Kiusalaas.</p>
<p>We want to solve <span class="math notranslate nohighlight">\(y''(x) = -3 y(x) y'(x)\)</span> with <span class="math notranslate nohighlight">\(y(0) = 0 and \)</span>y(2) = 1$ using a finite difference method. We discretize the region and approximate the derivatives as:</p>
<p><span class="math notranslate nohighlight">\(y''(x) \approx \frac{y_{i-1} - 2 y_i + y_{i+1}}{h^2} \)</span></p>
<p><span class="math notranslate nohighlight">\(y'(x) \approx \frac{y_{i+1} - y_{i-1}}{2 h} \)</span></p>
<p>We define a function <span class="math notranslate nohighlight">\(y''(x) = F(x, y, y')\)</span>. At each node in our discretized region, we will have an equation that looks like <span class="math notranslate nohighlight">\(y''(x) - F(x, y, y') = 0\)</span>, which will be nonlinear in the unknown solution <span class="math notranslate nohighlight">\(y\)</span>. The set of equations to solve is:</p>
<p>\begin{eqnarray}
y_0 - \alpha &amp;=&amp; 0 \
\frac{y_{i-1} - 2 y_i + y_{i+1}}{h^2} + (3 y_i) (\frac{y_{i+1} - y_{i-1}}{2 h}) &amp;=&amp; 0 \
y_L - \beta &amp;=&amp;0
\end{eqnarray}</p>
<p>Since we use a nonlinear solver, we will have to provide an initial guess to the solution. We will in this case assume a line. In other cases, a bad initial guess may lead to no solution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">fsolve</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">x1</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">x2</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">beta</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">11</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">Ypp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yprime</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;define y&#39;&#39; = 3*y*y&#39; &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="o">-</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="n">yprime</span>

<span class="k">def</span><span class="w"> </span><span class="nf">residuals</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;When we have the right values of y, this function will be zero.&#39;&#39;&#39;</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">alpha</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">YPP</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">h</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">YP</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">YPP</span> <span class="o">-</span> <span class="n">Ypp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">YP</span><span class="p">)</span>

    <span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">beta</span>
    <span class="k">return</span> <span class="n">res</span>

<span class="c1"># we need an initial guess</span>
<span class="n">init</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">+</span> <span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="n">X</span>

<span class="n">Y</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/cf5fdf769cd0e1208154a475e28bf12a07eb93c3307f3ec437f49436a8087cc1.png" src="../_images/cf5fdf769cd0e1208154a475e28bf12a07eb93c3307f3ec437f49436a8087cc1.png" />
</div>
</div>
</section>
</section>
<section id="partial-differential-equations">
<h2>Partial differential equations<a class="headerlink" href="#partial-differential-equations" title="Link to this heading">#</a></h2>
<section id="modeling-a-transient-plug-flow-reactor">
<h3>Modeling a transient plug flow reactor<a class="headerlink" href="#modeling-a-transient-plug-flow-reactor" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="http://matlab.cheme.cmu.edu/2011/11/17/modeling-a-transient-plug-flow-reactor">Matlab post</a></p>
<p>The PDE that describes the transient behavior of a plug flow reactor with constant volumetric flow rate is:</p>
<p><span class="math notranslate nohighlight">\( \frac{\partial C_A}{\partial dt} = -\nu_0 \frac{\partial C_A}{\partial dV} + r_A \)</span>.</p>
<p>To solve this numerically in python, we will utilize the method of lines. The idea is to discretize the reactor in volume, and approximate the spatial derivatives by finite differences. Then we will have a set of coupled ordinary differential equations that can be solved in the usual way. Let us simplify the notation with <span class="math notranslate nohighlight">\(C = C_A\)</span>, and let <span class="math notranslate nohighlight">\(r_A = -k C^2\)</span>. Graphically this looks like this:</p>
<p><img alt="img" src="../_images/pde-method-of-lines.png" /></p>
<p>This leads to the following set of equations:</p>
<p>\begin{eqnarray}
\frac{dC_0}{dt} &amp;=&amp; 0 \text{ (entrance concentration never changes)} \
\frac{dC_1}{dt} &amp;=&amp; -\nu_0 \frac{C_1 - C_0}{V_1 - V_0} - k C_1^2 \
\frac{dC_2}{dt} &amp;=&amp; -\nu_0 \frac{C_2 - C_1}{V_2 - V_1} - k C_2^2 \
\vdots \
\frac{dC_4}{dt} &amp;=&amp; -\nu_0 \frac{C_4 - C_3}{V_4 - V_3} - k C_4^2
\end{eqnarray}</p>
<p>Last, we need initial conditions for all the nodes in the discretization. Let us assume the reactor was full of empty solvent, so that <span class="math notranslate nohighlight">\(C_i = 0\)</span> at <span class="math notranslate nohighlight">\(t=0\)</span>. In the next block of code, we get the transient solutions, and the steady state solution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">odeint</span>

<span class="n">Ca0</span> <span class="o">=</span> <span class="mi">2</span>     <span class="c1"># Entering concentration</span>
<span class="n">vo</span> <span class="o">=</span> <span class="mi">2</span>      <span class="c1"># volumetric flow rate</span>
<span class="n">volume</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1"># total volume of reactor, spacetime = 10</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>       <span class="c1"># reaction rate constant</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>     <span class="c1"># number of points to discretize the reactor volume on</span>

<span class="n">init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>    <span class="c1"># Concentration in reactor at t = 0</span>
<span class="n">init</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ca0</span>         <span class="c1"># concentration at entrance</span>

<span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> <span class="c1"># discretized volume elements</span>
<span class="n">tspan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>    <span class="c1"># time span to integrate over</span>

<span class="k">def</span><span class="w"> </span><span class="nf">method_of_lines</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="s1">&#39;coupled ODES at each node point&#39;</span>
    <span class="n">D</span> <span class="o">=</span> <span class="o">-</span><span class="n">vo</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">C</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">V</span><span class="p">)</span> <span class="o">-</span> <span class="n">k</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="c1">#C0 is constant at entrance</span>
                            <span class="n">D</span><span class="p">])</span>

<span class="n">sol</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">method_of_lines</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">tspan</span><span class="p">)</span>

<span class="c1"># steady state solution</span>
<span class="k">def</span><span class="w"> </span><span class="nf">pfr</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">V</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">vo</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">k</span> <span class="o">*</span> <span class="n">C</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="n">ssol</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">pfr</span><span class="p">,</span> <span class="n">Ca0</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The transient solution contains the time dependent behavior of each node in the discretized reactor. Each row contains the concentration as a function of volume at a specific time point. For example, we can plot the concentration of A at the exit vs. time (that is, the last entry of each row) as:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tspan</span><span class="p">,</span> <span class="n">sol</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$C_A$ at exit&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5332e14d77ba6b0ce7301c18ff0907d5c25b9fc8e58c0b8fb57ba6684d9ac066.png" src="../_images/5332e14d77ba6b0ce7301c18ff0907d5c25b9fc8e58c0b8fb57ba6684d9ac066.png" />
</div>
</div>
<p>After approximately one space time, the steady state solution is reached at the exit. For completeness, we also examine the steady state solution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">ssol</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Steady state&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">sol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;t = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tspan</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Volume&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$C_A$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/30ca9d1e346e82aaff53b9a61a82070a9d787e78ec7dbce921fbd0a09c905343.png" src="../_images/30ca9d1e346e82aaff53b9a61a82070a9d787e78ec7dbce921fbd0a09c905343.png" />
</div>
</div>
<p>There is some minor disagreement between the final transient solution and the steady state solution. That is due to the approximation in discretizing the reactor volume. In this example we used 100 nodes. You get better agreement with a larger number of nodes, say 200 or more. Of course, it takes slightly longer to compute then, since the number of coupled odes is equal to the number of nodes.</p>
<p>We can also create an animated gif to show how the concentration of A throughout the reactor varies with time. Note, I had to install ffmpeg (<a class="reference external" href="http://ffmpeg.org/">http://ffmpeg.org/</a>) to save the animation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">animation</span>

<span class="c1"># make empty figure</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">line</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="n">line</span><span class="o">.</span><span class="n">set_xdata</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">line</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">sol</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;t = </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tspan</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">line</span><span class="p">,</span>


<span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>  <span class="n">blit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;images/transient_pfr.mp4&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MovieWriter ffmpeg unavailable; using Pillow instead.
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyError</span><span class="g g-Whitespace">                                  </span>Traceback (most recent call last)
<span class="nn">File /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/PIL/Image.py:2526,</span> in <span class="ni">Image.save</span><span class="nt">(self, fp, format, **params)</span>
<span class="g g-Whitespace">   </span><span class="mi">2525</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">2526</span>     <span class="nb">format</span> <span class="o">=</span> <span class="n">EXTENSION</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span>
<span class="g g-Whitespace">   </span><span class="mi">2527</span> <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>

<span class="ne">KeyError</span>: &#39;.mp4&#39;

<span class="n">The</span> <span class="n">above</span> <span class="n">exception</span> <span class="n">was</span> <span class="n">the</span> <span class="n">direct</span> <span class="n">cause</span> <span class="n">of</span> <span class="n">the</span> <span class="n">following</span> <span class="n">exception</span><span class="p">:</span>

<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">36</span><span class="p">],</span> <span class="n">line</span> <span class="mi">18</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span>     <span class="k">return</span> <span class="n">line</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">16</span> <span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>  <span class="n">blit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">18</span> <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;images/transient_pfr.mp4&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/matplotlib/animation.py:1098,</span> in <span class="ni">Animation.save</span><span class="nt">(self, filename, writer, fps, dpi, codec, bitrate, extra_args, metadata, extra_anim, savefig_kwargs, progress_callback)</span>
<span class="g g-Whitespace">   </span><span class="mi">1093</span>     <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">a</span>
<span class="g g-Whitespace">   </span><span class="mi">1095</span> <span class="c1"># canvas._is_saving = True makes the draw_event animation-starting</span>
<span class="g g-Whitespace">   </span><span class="mi">1096</span> <span class="c1"># callback a no-op; canvas.manager = None prevents resizing the GUI</span>
<span class="g g-Whitespace">   </span><span class="mi">1097</span> <span class="c1"># widget (both are likewise done in savefig()).</span>
<span class="ne">-&gt; </span><span class="mi">1098</span> <span class="k">with</span> <span class="p">(</span><span class="n">writer</span><span class="o">.</span><span class="n">saving</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fig</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="p">),</span>
<span class="g g-Whitespace">   </span><span class="mi">1099</span>       <span class="n">cbook</span><span class="o">.</span><span class="n">_setattr_cm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fig</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span> <span class="n">_is_saving</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">)):</span>
<span class="g g-Whitespace">   </span><span class="mi">1100</span>     <span class="k">if</span> <span class="ow">not</span> <span class="n">writer</span><span class="o">.</span><span class="n">_supports_transparency</span><span class="p">():</span>
<span class="g g-Whitespace">   </span><span class="mi">1101</span>         <span class="n">facecolor</span> <span class="o">=</span> <span class="n">savefig_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;facecolor&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1102</span>                                        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;savefig.facecolor&#39;</span><span class="p">])</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/contextlib.py:144,</span> in <span class="ni">_GeneratorContextManager.__exit__</span><span class="nt">(self, typ, value, traceback)</span>
<span class="g g-Whitespace">    </span><span class="mi">142</span> <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">143</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">144</span>         <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">145</span>     <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">146</span>         <span class="k">return</span> <span class="kc">False</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/matplotlib/animation.py:226,</span> in <span class="ni">AbstractMovieWriter.saving</span><span class="nt">(self, fig, outfile, dpi, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">224</span>     <span class="k">yield</span> <span class="bp">self</span>
<span class="g g-Whitespace">    </span><span class="mi">225</span> <span class="k">finally</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">226</span>     <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/matplotlib/animation.py:506,</span> in <span class="ni">PillowWriter.finish</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">505</span> <span class="k">def</span><span class="w"> </span><span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">506</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">507</span>         <span class="bp">self</span><span class="o">.</span><span class="n">outfile</span><span class="p">,</span> <span class="n">save_all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">append_images</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
<span class="g g-Whitespace">    </span><span class="mi">508</span>         <span class="n">duration</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">1000</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fps</span><span class="p">),</span> <span class="n">loop</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/PIL/Image.py:2529,</span> in <span class="ni">Image.save</span><span class="nt">(self, fp, format, **params)</span>
<span class="g g-Whitespace">   </span><span class="mi">2527</span>     <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">2528</span>         <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;unknown file extension: </span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="ne">-&gt; </span><span class="mi">2529</span>         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<span class="g g-Whitespace">   </span><span class="mi">2531</span> <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageFile</span>
<span class="g g-Whitespace">   </span><span class="mi">2533</span> <span class="c1"># may mutate self!</span>

<span class="ne">ValueError</span>: unknown file extension: .mp4
</pre></div>
</div>
<img alt="../_images/fe2dea8a9a3a05beb24e942d5630a05ef244ce4d7b716a55ae1fde45724bff4a.png" src="../_images/fe2dea8a9a3a05beb24e942d5630a05ef244ce4d7b716a55ae1fde45724bff4a.png" />
</div>
</div>
<p>You can see from the animation that after about 10 time units, the solution is not changing further, suggesting steady state has been reached.</p>
</section>
<section id="transient-heat-conduction-partial-differential-equations">
<h3>Transient heat conduction - partial differential equations<a class="headerlink" href="#transient-heat-conduction-partial-differential-equations" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="http://matlab.cheme.cmu.edu/2011/08/21/transient-heat-conduction-partial-differential-equations/">Matlab post</a>
adapated from <a class="reference external" href="http://msemac.redwoods.edu/~darnold/math55/DEproj/sp02/AbeRichards/slideshowdefinal.pdf">http://msemac.redwoods.edu/~darnold/math55/DEproj/sp02/AbeRichards/slideshowdefinal.pdf</a></p>
<p>We solved a steady state BVP modeling heat conduction. Today we examine the transient behavior of a rod at constant T put between two heat reservoirs at different temperatures, again T1 = 100, and T2 = 200. The rod will start at 150. Over time, we should expect a solution that approaches the steady state solution: a linear temperature profile from one side of the rod to the other.</p>
<p><span class="math notranslate nohighlight">\(\frac{\partial u}{\partial t} = k \frac{\partial^2 u}{\partial x^2}\)</span></p>
<p>at <span class="math notranslate nohighlight">\(t=0\)</span>, in this example we have <span class="math notranslate nohighlight">\(u_0(x) = 150\)</span> as an initial condition. with boundary conditions <span class="math notranslate nohighlight">\(u(0,t)=100\)</span> and <span class="math notranslate nohighlight">\(u(L,t)=200\)</span>.</p>
<p>In Matlab there is the pdepe command. There is not yet a PDE solver in scipy. Instead, we will utilze the method of lines to solve this problem. We discretize the rod into segments, and approximate the second derivative in the spatial dimension as <span class="math notranslate nohighlight">\(\frac{\partial^2 u}{\partial x^2} = (u(x + h) - 2 u(x) + u(x-h))/ h^2\)</span> at each node. This leads to a set of coupled ordinary differential equations that is easy to solve.</p>
<p>Let us say the rod has a length of 1, <span class="math notranslate nohighlight">\(k=0.02\)</span>, and solve for the time-dependent temperature profiles.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">odeint</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># number of points to discretize</span>
<span class="n">L</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> <span class="c1"># position along the rod</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">L</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">k</span> <span class="o">=</span> <span class="mf">0.02</span>

<span class="k">def</span><span class="w"> </span><span class="nf">odefunc</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="n">dudt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">dudt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># constant at boundary condition</span>
    <span class="n">dudt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># now for the internal nodes</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">dudt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">h</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">dudt</span>

<span class="n">init</span> <span class="o">=</span> <span class="mf">150.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># initial temperature</span>
<span class="n">init</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.0</span>  <span class="c1"># one boundary condition</span>
<span class="n">init</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">200.0</span> <span class="c1"># the other boundary condition</span>

<span class="n">tspan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">odefunc</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">tspan</span><span class="p">)</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tspan</span><span class="p">),</span> <span class="mi">5</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">sol</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;t=</span><span class="si">{0:1.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tspan</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

<span class="c1"># put legend outside the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;X position&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Temperature&#39;</span><span class="p">)</span>

<span class="c1"># adjust figure edges so the legend is in the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.77</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/cb6a2e5508063c944c3e3f161e54112d382bf0b5780dbc347bddab9e1eb542a8.png" src="../_images/cb6a2e5508063c944c3e3f161e54112d382bf0b5780dbc347bddab9e1eb542a8.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make a 3d figure</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>

<span class="n">SX</span><span class="p">,</span> <span class="n">ST</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">tspan</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">SX</span><span class="p">,</span> <span class="n">ST</span><span class="p">,</span> <span class="n">sol</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">azim</span><span class="o">=-</span><span class="mi">124</span><span class="p">)</span> <span class="c1"># adjust view so it is easy to see;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0eac405e3fca744d04f32f218bc37465ed79a55d43ebca4f2f116d12f2a8028c.png" src="../_images/0eac405e3fca744d04f32f218bc37465ed79a55d43ebca4f2f116d12f2a8028c.png" />
</div>
</div>
<p>This version of the graphical solution is not that easy to read, although with some study you can see the solution evolves from the initial condition which is flat, to the steady state solution which is a linear temperature ramp.</p>
<p>The 3d version may be easier to interpret. The temperature profile starts out flat, and gradually changes to the linear ramp.</p>
</section>
<section id="transient-diffusion-partial-differential-equations">
<h3>Transient diffusion - partial differential equations<a class="headerlink" href="#transient-diffusion-partial-differential-equations" title="Link to this heading">#</a></h3>
<p>We want to solve for the concentration profile of  component that diffuses into a 1D rod, with an impermeable barrier at the end. The PDE governing this situation is:</p>
<p><span class="math notranslate nohighlight">\(\frac{\partial C}{\partial t} = D \frac{\partial^2 C}{\partial x^2}\)</span></p>
<p>at <span class="math notranslate nohighlight">\(t=0\)</span>, in this example we have <span class="math notranslate nohighlight">\(C_0(x) = 0\)</span> as an initial condition, with boundary conditions <span class="math notranslate nohighlight">\(C(0,t)=0.1\)</span> and <span class="math notranslate nohighlight">\(\partial C/ \partial x(L,t)=0\)</span>.</p>
<p>We are going to discretize this equation in both time and space to arrive at the solution. We will let <span class="math notranslate nohighlight">\(i\)</span> be the index for the spatial discretization, and <span class="math notranslate nohighlight">\(j\)</span> be the index for the temporal discretization. The discretization looks like this.</p>
<p><img alt="img" src="../_images/pde-diffusion-discretization-scheme.png" /></p>
<p>Note that we cannot use the method of lines as we did before because we have the derivative-based boundary condition at one of the boundaries.</p>
<p>We approximate the time derivative as:</p>
<p><span class="math notranslate nohighlight">\(\frac{\partial C}{\partial t} \bigg| _{i,j} \approx \frac{C_{i,j+1} - C_{i,j}}{\Delta t} \)</span></p>
<p><span class="math notranslate nohighlight">\(\frac{\partial^2 C}{\partial  x^2} \bigg| _{i,j} \approx \frac{C_{i+1,j} - 2 C_{i,j} + C_{i-1,j}}{h^2} \)</span></p>
<p>We define <span class="math notranslate nohighlight">\(\alpha = \frac{D \Delta t}{h^2}\)</span>, and from these two approximations and the PDE, we solve for the unknown solution at a later time step as:</p>
<p><span class="math notranslate nohighlight">\(C_{i, j+1} = \alpha C_{i+1,j} + (1 - 2 \alpha) C_{i,j}  + \alpha C_{i-1,j} \)</span></p>
<p>We know <span class="math notranslate nohighlight">\(C_{i,j=0}\)</span> from the initial conditions, so we simply need to iterate to evaluate <span class="math notranslate nohighlight">\(C_{i,j}\)</span>, which is the solution at each time step.</p>
<p>See also: <a class="reference external" href="http://www3.nd.edu/~jjwteach/441/PdfNotes/lecture16.pdf">http://www3.nd.edu/~jjwteach/441/PdfNotes/lecture16.pdf</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># number of points to discretize</span>
<span class="n">L</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> <span class="c1"># position along the rod</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">L</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>          <span class="c1"># discretization spacing</span>

<span class="n">C0t</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># concentration at x = 0</span>
<span class="n">D</span> <span class="o">=</span> <span class="mf">0.02</span>

<span class="n">tfinal</span> <span class="o">=</span> <span class="mf">50.0</span>
<span class="n">Ntsteps</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">tfinal</span> <span class="o">/</span> <span class="p">(</span><span class="n">Ntsteps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tfinal</span><span class="p">,</span> <span class="n">Ntsteps</span><span class="p">)</span>

<span class="n">alpha</span> <span class="o">=</span> <span class="n">D</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">h</span><span class="o">**</span><span class="mi">2</span>
<span class="nb">print</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>

<span class="n">C_xt</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># container for all the time steps</span>

<span class="c1"># initial condition at t = 0</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">C0t</span>

<span class="n">C_xt</span> <span class="o">+=</span> <span class="p">[</span><span class="n">C</span><span class="p">]</span>

<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Ntsteps</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">N</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">C0t</span>
    <span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">N</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># derivative boundary condition flux = 0</span>
    <span class="n">C</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">N</span>
    <span class="n">C_xt</span> <span class="o">+=</span> <span class="p">[</span><span class="n">N</span><span class="p">]</span>

    <span class="c1"># plot selective solutions</span>
    <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">500</span><span class="p">]:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;t=</span><span class="si">{0:1.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Position in rod&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Concentration&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Concentration at different times&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>

<span class="n">C_xt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">C_xt</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">C_xt</span><span class="p">[:,</span><span class="mi">5</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;x=</span><span class="si">{0:1.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">C_xt</span><span class="p">[:,</span><span class="mi">10</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;x=</span><span class="si">{0:1.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">10</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">C_xt</span><span class="p">[:,</span><span class="mi">15</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;x=</span><span class="si">{0:1.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">15</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">C_xt</span><span class="p">[:,</span><span class="mi">19</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;x=</span><span class="si">{0:1.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">19</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Concentration&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.36136136136136143
</pre></div>
</div>
<img alt="../_images/2136f6951039c8d56577901053b0465a665af5413dc892de33be188ad9dacb45.png" src="../_images/2136f6951039c8d56577901053b0465a665af5413dc892de33be188ad9dacb45.png" />
<img alt="../_images/a2f40e6b11401dac4fe26c4bf6bfbb42956e55cd01f080862e297f8f527baa46.png" src="../_images/a2f40e6b11401dac4fe26c4bf6bfbb42956e55cd01f080862e297f8f527baa46.png" />
</div>
</div>
<p>The solution is somewhat sensitive to the choices of time step and spatial discretization. If you make the time step too big, the method is not stable, and large oscillations may occur.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./blog"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="optimization.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Optimization</p>
      </div>
    </a>
    <a class="right-next"
       href="plotting.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Plotting</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ordinary-differential-equations">Ordinary differential equations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#numerical-solution-to-a-simple-ode">Numerical solution to a simple ode</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-ode-solutions-in-cylindrical-coordinates">Plotting ODE solutions in cylindrical coordinates</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#odes-with-discontinuous-forcing-functions">ODEs with discontinuous forcing functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#simulating-the-events-feature-of-matlab-s-ode-solvers">Simulating the events feature of Matlab’s ode solvers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mimicking-ode-events-in-python">Mimicking ode events in python</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solving-an-ode-for-a-specific-solution-value">Solving an ode for a specific solution value</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-simple-first-order-ode-evaluated-at-specific-points">A simple first order ode evaluated at specific points</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#error-tolerance-in-numerical-solutions-to-odes">Error tolerance in numerical solutions to ODEs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solving-parameterized-odes-over-and-over-conveniently">Solving parameterized ODEs over and over conveniently</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#yet-another-way-to-parameterize-an-ode">Yet another way to parameterize an ODE</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#another-way-to-parameterize-an-ode-nested-function">Another way to parameterize an ODE - nested function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solving-a-second-order-ode">Solving a second order ode</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solving-bessel-s-equation-numerically">Solving Bessel’s Equation numerically</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#phase-portraits-of-a-system-of-odes">Phase portraits of a system of ODEs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#linear-algebra-approaches-to-solving-systems-of-constant-coefficient-odes">Linear algebra approaches to solving systems of constant coefficient ODEs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#delay-differential-equations">Delay Differential Equations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#differential-algebraic-systems-of-equations">Differential algebraic systems of equations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#boundary-value-equations">Boundary value equations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plane-poiseuille-flow-bvp-solve-by-shooting-method">Plane Poiseuille flow - BVP solve by shooting method</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#first-guess">First guess</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#second-guess">Second guess</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#let-fsolve-do-the-work">Let fsolve do the work</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plane-poiseuelle-flow-solved-by-finite-difference">Plane poiseuelle flow solved by finite difference</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#boundary-value-problem-in-heat-conduction">Boundary value problem in heat conduction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-nonlinear-bvp">A nonlinear BVP</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-differential-equations">Partial differential equations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#modeling-a-transient-plug-flow-reactor">Modeling a transient plug flow reactor</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#transient-heat-conduction-partial-differential-equations">Transient heat conduction - partial differential equations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#transient-diffusion-partial-differential-equations">Transient diffusion - partial differential equations</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By John Kitchin
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <!-- RAG Chat Widget - Self-contained version for Jupyter Book -->
<style>
/* RAG Widget Styles */
:root {
    --widget-primary-color: #1f77b4;
    --widget-primary-hover: #1565a8;
    --widget-bg-color: #ffffff;
    --widget-text-color: #262730;
    --widget-border-color: #e0e0e0;
    --widget-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    --widget-shadow-lg: 0 12px 32px rgba(0, 0, 0, 0.2);
    --widget-border-radius: 16px;
    --widget-button-size: 60px;
    --widget-z-index: 9999;
}

.rag-widget {
    position: fixed;
    z-index: var(--widget-z-index);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
    bottom: 20px;
    right: 20px;
}

.widget-button {
    width: var(--widget-button-size);
    height: var(--widget-button-size);
    border-radius: 50%;
    background-color: var(--widget-primary-color);
    border: none;
    box-shadow: var(--widget-shadow);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.widget-button:hover {
    background-color: var(--widget-primary-hover);
    box-shadow: var(--widget-shadow-lg);
    transform: scale(1.05);
}

.widget-button:active {
    transform: scale(0.95);
}

.widget-icon,
.widget-close-icon {
    width: 28px;
    height: 28px;
    color: white;
    transition: all 0.3s ease;
    position: absolute;
}

.widget-close-icon {
    opacity: 0;
    transform: rotate(90deg) scale(0);
}

.widget-button.active .widget-icon {
    opacity: 0;
    transform: rotate(-90deg) scale(0);
}

.widget-button.active .widget-close-icon {
    opacity: 1;
    transform: rotate(0deg) scale(1);
}

.widget-container {
    position: fixed;
    bottom: 90px;
    right: 20px;
    width: min(50vw, calc(100vw - 40px));
    height: min(600px, calc(100vh - 120px));
    max-width: calc(100vw - 40px);
    max-height: calc(100vh - 120px);
    background-color: var(--widget-bg-color);
    border-radius: var(--widget-border-radius);
    box-shadow: var(--widget-shadow-lg);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    opacity: 0;
    transform: scale(0.9) translateY(10px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
}

.widget-container.visible {
    opacity: 1;
    transform: scale(1) translateY(0);
    pointer-events: all;
}

.widget-container.hidden {
    display: none;
}

.widget-header {
    background-color: var(--widget-primary-color);
    color: white;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
}

.widget-header-content {
    flex: 1;
}

.widget-title {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    line-height: 1.2;
}

.widget-subtitle {
    margin: 4px 0 0 0;
    font-size: 13px;
    opacity: 0.9;
    line-height: 1.2;
}

.widget-minimize-btn {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: background-color 0.2s ease;
}

.widget-minimize-btn:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.widget-minimize-btn svg {
    width: 20px;
    height: 20px;
}

.widget-iframe-container {
    flex: 1;
    position: relative;
    overflow: hidden;
    background-color: #f5f5f5;
}

#widget-iframe {
    width: 100%;
    height: 100%;
    border: none;
}

.widget-footer {
    padding: 12px 20px;
    background-color: var(--widget-bg-color);
    border-top: 1px solid var(--widget-border-color);
    text-align: center;
    flex-shrink: 0;
}

.widget-powered-by {
    font-size: 12px;
    color: #666;
}

.widget-powered-by a {
    color: var(--widget-primary-color);
    text-decoration: none;
    font-weight: 500;
}

.widget-powered-by a:hover {
    text-decoration: underline;
}

@media (max-width: 768px) {
    .widget-container {
        width: 100%;
        height: 100%;
        max-width: 100%;
        max-height: 100%;
        bottom: 0;
        right: 0;
        left: 0;
        top: 0;
        border-radius: 0;
    }

    .widget-button {
        width: 56px;
        height: 56px;
    }

    .widget-icon,
    .widget-close-icon {
        width: 24px;
        height: 24px;
    }
}

@media (max-width: 480px) {
    .rag-widget {
        bottom: 16px;
        right: 16px;
    }
}

.widget-iframe-container::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--widget-primary-color);
    border-radius: 50%;
    animation: widget-spin 1s linear infinite;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.widget-iframe-container.loading::before {
    opacity: 1;
}

@keyframes widget-spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

@media (prefers-color-scheme: dark) {
    :root {
        --widget-bg-color: #1e1e1e;
        --widget-text-color: #ffffff;
        --widget-border-color: #333333;
    }

    .widget-iframe-container {
        background-color: #252525;
    }
}

.widget-button:focus,
.widget-minimize-btn:focus {
    outline: 2px solid var(--widget-primary-color);
    outline-offset: 2px;
}

@media print {
    .rag-widget {
        display: none !important;
    }
}
</style>

<div id="rag-widget" class="rag-widget">
    <!-- Floating Button -->
    <button id="widget-button" class="widget-button" aria-label="Open chat">
        <svg class="widget-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
            <path d="M7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/>
        </svg>
        <svg class="widget-close-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
    </button>

    <!-- Chat Container -->
    <div id="widget-container" class="widget-container hidden">
        <!-- Header -->
        <div class="widget-header">
            <div class="widget-header-content">
                <h3 class="widget-title">Secret A(i)gent</h3>
                <p class="widget-subtitle">Ask me anything</p>
            </div>
            <button id="widget-minimize" class="widget-minimize-btn" aria-label="Minimize chat">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 13H5v-2h14v2z"/>
                </svg>
            </button>
        </div>

        <!-- Chat iframe -->
        <div class="widget-iframe-container">
            <iframe
                id="widget-iframe"
                src=""
                frameborder="0"
                allow="clipboard-write"
                title="RAG Chat Assistant">
            </iframe>
        </div>

        <!-- Footer -->
        <div class="widget-footer">
            <span class="widget-powered-by">
                Powered by <a href="https://github.com/jkitchin/streamlit-rag-widget" target="_blank">a Secret A(i)gent</a>
            </span>
        </div>
    </div>
</div>

<script>
/**
 * RAG Widget Configuration and Script
 */
(function() {
    'use strict';

    // Configuration
    const config = {
        streamlitUrl: 'https://kitchin-services.cheme.cmu.edu',
        position: 'bottom-right',
        width: '50vw',
        height: '600px',
        primaryColor: '#1f77b4',
        title: 'Secret A(i)gent',
        subtitle: 'Ask me anything',
        showPoweredBy: true,
        autoOpen: false,
        openDelay: 0,
        zIndex: 9999,
    };

    // Widget state
    let isOpen = false;

    // Get DOM elements
    const widget = document.getElementById('rag-widget');
    const button = document.getElementById('widget-button');
    const container = document.getElementById('widget-container');
    const iframe = document.getElementById('widget-iframe');
    const minimizeBtn = document.getElementById('widget-minimize');
    const iframeContainer = document.querySelector('.widget-iframe-container');

    if (!widget || !button || !container || !iframe) {
        console.error('RAG Widget: Required elements not found');
        return;
    }

    /**
     * Initialize widget
     */
    function init() {
        // Set iframe URL
        iframe.src = config.streamlitUrl;

        // Set custom colors
        if (config.primaryColor) {
            document.documentElement.style.setProperty('--widget-primary-color', config.primaryColor);
        }

        // Set title and subtitle
        const title = document.querySelector('.widget-title');
        const subtitle = document.querySelector('.widget-subtitle');
        if (title && config.title) {
            title.textContent = config.title;
        }
        if (subtitle && config.subtitle) {
            subtitle.textContent = config.subtitle;
        }

        // Hide powered by if configured
        if (!config.showPoweredBy) {
            const footer = document.querySelector('.widget-footer');
            if (footer) {
                footer.style.display = 'none';
            }
        }

        // Add event listeners
        button.addEventListener('click', toggleWidget);
        minimizeBtn.addEventListener('click', closeWidget);

        // Handle keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && isOpen) {
                closeWidget();
            }
        });

        // Auto-open if configured
        if (config.autoOpen) {
            setTimeout(openWidget, config.openDelay);
        }

        console.log('RAG Widget initialized');
    }

    /**
     * Toggle widget open/closed
     */
    function toggleWidget() {
        if (isOpen) {
            closeWidget();
        } else {
            openWidget();
        }
    }

    /**
     * Open widget
     */
    function openWidget() {
        isOpen = true;
        button.classList.add('active');
        container.classList.remove('hidden');

        setTimeout(function() {
            container.classList.add('visible');
        }, 10);

        setTimeout(function() {
            iframe.focus();
        }, 300);
    }

    /**
     * Close widget
     */
    function closeWidget() {
        isOpen = false;
        button.classList.remove('active');
        container.classList.remove('visible');

        setTimeout(function() {
            container.classList.add('hidden');
        }, 300);
    }

    /**
     * Public API
     */
    window.RAGWidget = {
        open: openWidget,
        close: closeWidget,
        toggle: toggleWidget,
        isOpen: function() { return isOpen; }
    };

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

})();
</script>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>